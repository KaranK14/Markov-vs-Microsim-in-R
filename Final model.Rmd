---
title: "Markov model - BBV transmission - time independent model"
author: "Karan Ketan Shah"
date: "2023-09-2023"
output: html_document

Adapted from Alarid-Escudero F, Krijkamp E, Enns EA, et al. An introductory tutorial on cohort state-transition models in r using a cost-effectiveness analysis example. 2023;43(1):3-20
---

```{r , include=FALSE}
rm(list = ls())  # remove any variables in R's memory
options(scipen = 999)

# Sys.setenv(GITHUB_PAT = "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")
# 
# devtools::install_github("feralaes/dampack")
```

# Load libraries
```{r load libraries, echo=FALSE}
library(tidyverse)
library(dplyr)
library(readxl)
library(SciViews)
library(writexl)
library(ggplot2)
library(reshape2)
library(summarytools)
library(cowplot)
library(dampack)
library(gridExtra)

source(file.path("C:/Users/kshah/OneDrive - The University of Sydney (Staff)/Markov vs microsim/Model/Markov model/R/Functions.R"))
```

# Set directory
```{r set directory, echo=FALSE}
modelsloc <- 'C:/Users/kshah/OneDrive - The University of Sydney (Staff)/Markov vs microsim/Model/Markov model/Main script/Model deconstruction/'
inputsloc <-  'C:/Users/kshah/OneDrive - The University of Sydney (Staff)/Markov vs microsim/Model/Inputs'
figuresloc <- 'C:/Users/kshah/OneDrive - The University of Sydney (Staff)/Markov vs microsim/Model/Figures'
```

# Load inputs
```{r load R inputs, echo=FALSE}
load(file.path(inputsloc, 'costs.Rdata'))
load(file.path(inputsloc,'Utility.RData'))
load(file.path(inputsloc,'transition_probs.RData'))

```

# Start of the model
```{r model start, echo=FALSE}
#everyone will begin on the waitlist
v_names_str <- c("Current clinical practice", "Shift in clinical practice") # strategy names
n_str <- length(v_names_str)
disc_rate <- 0.0125 # discount rate adjusted for 3 monthly cycle length 5%/4 quarters
n_cycles <- 80 # number of cycles, mean age is 63 so upto 83 years of life expectancy
n_c <- 1 # number of people

# v_cycles_tunnel <- 1:n_tunnel_size # vector with cycles for tunnels
cycle_length <- 0.25

tp_SVR <- 1 - (1 - 0.965) ^ cycle_length # efficacy of DAA agents for patients with hepC
per_effect_hcv <- 0.05/4 # increase in % of kidney transplantation in proposed policy. These patients will directly go to HCV health state
per_effect_increased_risk_behaviours <- 0.02/4 # increase in % of kidney transplantation in proposed policy. These patients will directly go to SCD health states

tp_graft_failure <- round(tp_graft_failure, 4)

c_diagosis_proposed_policy <- 3348.9
```

# Create vectors
```{r create names vector, echo=FALSE}
# v_names_on_waitlist <- paste("Waitlist", seq(1, n_tunnel_size), "", sep = "")
# v_names_off_waitlist <- paste("Dialysis", seq(1, n_tunnel_size), "", sep = "")

# names of the health states in the model
v_names_health_states <-
  c(
    "On waitlist",
    "DBD SCD good",
    "DBD SCD moderate",
    "DBD SCD poor",
    "DBD ECD good",
    "DBD ECD moderate",
    "DBD ECD poor",
    "DCD good",
    "DCD moderate",
    "DCD poor",
    "Good graft DBD SCD",
    "Good graft DBD ECD",
    "Good graft DCD",
    "Moderate graft DBD SCD",
    "Moderate graft DBD ECD",
    "Moderate graft DCD",
    "Poor graft DBD SCD",
    "Poor graft DBD ECD",
    "Poor graft DCD",
    "Off waitlist",
    "HIV",
    "HBV",
    "Hep B Comp cirr",
    "Hep B Decomp cirr",
    "Hep B HCC",
    "Spon clearance",
    "HCV",
    "Hep C comp cirr",
    "Hep C Decomp cirr",
    "Hep C HCC",
    "SVR",
    "Liver transplant 3",
    "Liver transplant 6",
    "Liver transplant 9",
    "Liver transplant 12",
    "Liver transplant yr 2",
    "Death on waitlist",
    "Death off waitlist",
    "Death after graft failure",
    "Death w functioning graft",
    "Death end stage liver")

length(v_names_health_states)
```

# Create other variables and matrices
```{r, echo=FALSE}
n_states <- length(v_names_health_states) # number of health states
v_m_on_waitlist <- c(1, rep(0, 40)) # all starting on waitlist in year 1

length(v_m_on_waitlist)

# initialise cohort trace for state-residence dependent cSTM
m_M_current_practice <- matrix(
  0,
  nrow = (n_cycles + 1),
  ncol = n_states,
  dimnames = list(0:n_cycles, v_names_health_states)
)
```

# Initialise cohort trace for both current and proposed practice
```{r}
# store the initial state vector in the first row of the cohort trace
m_M_current_practice[1, ] <- v_m_on_waitlist

##* initialize cohort trace for proposed strategy
#* structure and initial states are the same as for current practice
m_M_proposed_practice <- m_M_current_practice

```

# Create a transition probability matrix
```{r}
m_P_current_practice <- matrix(0,
                               nrow = n_states, ncol = n_states,
                               dimnames = list(v_names_health_states,
                                               v_names_health_states))

m_P_proposed_practice <- matrix(0,
                               nrow = n_states, ncol = n_states,
                               dimnames = list(v_names_health_states,
                                               v_names_health_states))
```

# Helper function for blood group transitions
```{r}
calculate_bloodgrp_transitions_transplant <-
  function(tp_transplant, pro_blood_grp) {
    return(
      tp_transplant_bloodgrp_A * pro_blood_grp_A +
        tp_transplant_bloodgrp_B * pro_blood_grp_B +
        tp_transplant_bloodgrp_AB * pro_blood_grp_AB +
        tp_transplant_bloodgrp_O * pro_blood_grp_O
    )
  }

calculate_bloodgrp_transitions_suspension <-
  function(tp_suspension, pro_blood_grp) {
    return(
      tp_off_waitlist_bloodgrp_A * pro_blood_grp_A +
        tp_off_waitlist_bloodgrp_B * pro_blood_grp_B +
        tp_off_waitlist_bloodgrp_AB * pro_blood_grp_AB +
        tp_off_waitlist_bloodgrp_O * pro_blood_grp_O
    )
  }

n_death_waitlist
```

# Decons - Fill in the matrix for current practice
```{r}
### Initialize transition probability matrix for strategy current practice ----
#* All transitions to a non-death state are assumed to be conditional on survival 

# From waitlist
m_P_current_practice["On waitlist", "Death on waitlist"] <- n_death_waitlist

# Calculate transitions for transplant and suspension using blood group proportions
bloodgrp_transition_transplant_DBDSCD = round(calculate_bloodgrp_transitions_transplant(tp_transplant, pro_blood_grp) * pro_DBDSCD, 3)
bloodgrp_transition_transplant_DBDECD = round(calculate_bloodgrp_transitions_transplant(tp_transplant, pro_blood_grp) * pro_DBDECD, 3)
bloodgrp_transition_transplant_DCD = round(calculate_bloodgrp_transitions_transplant(tp_transplant, pro_blood_grp) * pro_DCD, 3)

bloodgrp_transition_suspension_DBDSCD = round(calculate_bloodgrp_transitions_suspension(tp_suspension, pro_blood_grp) * pro_DBDSCD, 3)
bloodgrp_transition_suspension_DBDECD = round(calculate_bloodgrp_transitions_suspension(tp_suspension, pro_blood_grp) * pro_DBDECD, 3)
bloodgrp_transition_suspension_DCD = round(calculate_bloodgrp_transitions_suspension(tp_suspension, pro_blood_grp) * pro_DCD, 3)

susp_prob <- bloodgrp_transition_suspension_DBDSCD + bloodgrp_transition_suspension_DBDECD + bloodgrp_transition_suspension_DCD

tx_fail_to_off_wlst <-  round(bloodgrp_transition_transplant_DBDSCD * tp_graft_failure +
  bloodgrp_transition_transplant_DBDECD * tp_graft_failure +
  bloodgrp_transition_transplant_DCD * tp_graft_failure, 4)
  
  
# Transitions to transplant states
m_P_current_practice["On waitlist", "DBD SCD good"] <-
 round(bloodgrp_transition_transplant_DBDSCD * (1 - pro_DBDSCD_mg - pro_DBDSCD_pg - tp_graft_failure), 4)

m_P_current_practice["On waitlist", "DBD SCD moderate"] <-
 round(bloodgrp_transition_transplant_DBDSCD * pro_DBDSCD_mg,4) 

m_P_current_practice["On waitlist", "DBD SCD poor"] <-
 round(bloodgrp_transition_transplant_DBDSCD * pro_DBDSCD_pg, 4) 

m_P_current_practice["On waitlist", "DBD ECD good"] <-
 round(bloodgrp_transition_transplant_DBDECD * (1 - pro_DBDECD_mg - pro_DBDECD_pg - tp_graft_failure), 4)

m_P_current_practice["On waitlist", "DBD ECD moderate"] <-
 round(bloodgrp_transition_transplant_DBDECD * pro_DBDECD_mg, 4)

m_P_current_practice["On waitlist", "DBD ECD poor"] <-
round(bloodgrp_transition_transplant_DBDECD * pro_DBDECD_pg, 4)

m_P_current_practice["On waitlist", "DCD good"] <-
 round(bloodgrp_transition_transplant_DCD * (1 - pro_DCD_mg - pro_DCD_pg - tp_graft_failure), 4)

m_P_current_practice["On waitlist", "DCD moderate"] <-
 round(bloodgrp_transition_transplant_DCD * pro_DCD_mg, 4)

m_P_current_practice["On waitlist", "DCD poor"] <-
 round(bloodgrp_transition_transplant_DCD * pro_DCD_pg, 4)


# Transition to suspension off the waitlist
m_P_current_practice["On waitlist", "Off waitlist"] <-
 round(susp_prob + tx_fail_to_off_wlst
, 4)
  

# Sum of all transitions out of the current waitlist state
total_trans_prob =
  m_P_current_practice["On waitlist", "Death on waitlist"] +
  m_P_current_practice["On waitlist", "DBD SCD good"] +
  m_P_current_practice["On waitlist", "DBD SCD moderate"] +
  m_P_current_practice["On waitlist", "DBD SCD poor"] +
  m_P_current_practice["On waitlist", "DBD ECD good"] +
  m_P_current_practice["On waitlist", "DBD ECD moderate"] +
  m_P_current_practice["On waitlist", "DBD ECD poor"] +
  m_P_current_practice["On waitlist", "DCD good"] +
  m_P_current_practice["On waitlist", "DCD moderate"] +
  m_P_current_practice["On waitlist", "DCD poor"] +
  m_P_current_practice["On waitlist", "Off waitlist"]

m_P_current_practice["On waitlist", "On waitlist"] <-   1 - total_trans_prob


# From kidney transplant
## DBD SCD good
### to hepatitis B
m_P_current_practice["DBD SCD good", "HBV" ] <-
  round(tp_HBV_current_practice, 4) 

### to hepatitis C
m_P_current_practice["DBD SCD good", "HCV" ] <-
  round(tp_HCV_current_practice, 5) 

total_trans_prob_DBDSCD_good =
  m_P_current_practice["DBD SCD good", "HBV" ] +
  m_P_current_practice["DBD SCD good", "HCV"] 

### good graft function post kidney transplant. All the remaining patients would move here.
m_P_current_practice["DBD SCD good", "Good graft DBD SCD"] <-
  1 - total_trans_prob_DBDSCD_good


## DBD SCD moderate
### to hepatitis B
m_P_current_practice["DBD SCD moderate", "HBV"] <-
  round(tp_HBV_current_practice, 4)  

### to hepatitis C
m_P_current_practice["DBD SCD moderate", "HCV" ] <-
  round(tp_HCV_current_practice, 5) 


total_trans_prob_DBDSCD_moderate =
  m_P_current_practice["DBD SCD moderate", "HBV"] +
  m_P_current_practice["DBD SCD moderate", "HCV"]

### good graft function post kidney transplant. All the remaining patients would move here.
m_P_current_practice["DBD SCD moderate", "Moderate graft DBD SCD"] <-
  1 - total_trans_prob_DBDSCD_moderate


## DBD SCD poor
### to hepatitis B
m_P_current_practice["DBD SCD poor", "HBV" ] <-
  round(tp_HBV_current_practice, 4)   

### to hepatitis C
m_P_current_practice["DBD SCD poor", "HCV" ] <-
  round(tp_HCV_current_practice, 5) 


total_trans_prob_DBDSCD_poor =
  m_P_current_practice["DBD SCD poor", "HBV"] +
  m_P_current_practice["DBD SCD poor", "HCV" ] 

### good graft function post kidney transplant. All the remaining patients would move here.
m_P_current_practice["DBD SCD poor", "Poor graft DBD SCD" ] <-
  1 - total_trans_prob_DBDSCD_poor


## From DBD ECD good
### to hepatitis B
m_P_current_practice["DBD ECD good", "HBV"] <-
  round(tp_HBV_current_practice, 4)  

### to hepatitis C
m_P_current_practice["DBD ECD good", "HCV"] <-
  round(tp_HCV_current_practice, 5) 


total_trans_prob_DBDECD_good =
  m_P_current_practice["DBD ECD good", "HBV"] +
  m_P_current_practice["DBD ECD good", "HCV"]

### good graft function post kidney transplant. All the remaining patients would move here.
m_P_current_practice["DBD ECD good", "Good graft DBD ECD"] <-
  1 - total_trans_prob_DBDECD_good


## From DBD ECD moderate
### to hepatitis B
m_P_current_practice["DBD ECD moderate", "HBV" ] <-
  round(tp_HBV_current_practice, 4)  

### to hepatitis C
m_P_current_practice["DBD ECD moderate", "HCV" ] <-
  round(tp_HCV_current_practice, 5) 
 

total_trans_prob_DBDECD_moderate =
  m_P_current_practice["DBD ECD moderate", "HBV"] +
  m_P_current_practice["DBD ECD moderate", "HCV"] 

### moderate graft function post kidney transplant. All the remaining patients would move here.
m_P_current_practice["DBD ECD moderate", "Moderate graft DBD ECD"] <-
  1 - total_trans_prob_DBDECD_moderate


## From DBD ECD poor
### to hepatitis B
m_P_current_practice["DBD ECD poor", "HBV" ] <-
   round(tp_HBV_current_practice, 4)  

### to hepatitis C
m_P_current_practice["DBD ECD poor", "HCV"] <-
  round(tp_HCV_current_practice, 5) 


total_trans_prob_DBDECD_poor =
  m_P_current_practice["DBD ECD poor", "HBV" ] +
  m_P_current_practice["DBD ECD poor", "HCV" ]

### poor graft function post kidney transplant. All the remaining patients would move here.
m_P_current_practice["DBD ECD poor", "Poor graft DBD ECD"] <-
  1 - total_trans_prob_DBDECD_poor


## From DCD good
### to hepatitis B
m_P_current_practice["DCD good", "HBV"] <-
   round(tp_HBV_current_practice, 4)   

### to hepatitis C
m_P_current_practice["DCD good", "HCV" ] <-
  round(tp_HCV_current_practice, 5) 


total_trans_prob_DCD_good =
  m_P_current_practice["DCD good", "HBV" ] +
  m_P_current_practice["DCD good", "HCV" ] 

### good graft function post kidney transplant. All the remaining patients would move here.
m_P_current_practice["DCD good", "Good graft DCD" ] <-
  1 - total_trans_prob_DCD_good


## From DCD moderate
### to hepatitis B
m_P_current_practice["DCD moderate", "HBV"] <-
   round(tp_HBV_current_practice, 4)   

### to hepatitis C
m_P_current_practice["DCD moderate", "HCV" ] <-
  round(tp_HCV_current_practice, 5) 


total_trans_prob_DCD_moderate =
  m_P_current_practice["DCD moderate", "HBV" ] +
  m_P_current_practice["DCD moderate", "HCV" ]

### moderate graft function post kidney transplant. All the remaining patients would move here.
m_P_current_practice["DCD moderate", "Moderate graft DCD" ] <-
  1 - total_trans_prob_DCD_moderate


## From DCD poor
### to hepatitis B
m_P_current_practice["DCD poor", "HBV" ] <-
  round(tp_HBV_current_practice, 4)  
### to hepatitis C
m_P_current_practice["DCD poor", "HCV" ] <-
  round(tp_HCV_current_practice, 5) 


total_trans_prob_DCD_poor =
  m_P_current_practice["DCD poor", "HBV"] +
  m_P_current_practice["DCD poor", "HCV" ] 

### poor graft function post kidney transplant. All the remaining patients would move here.
m_P_current_practice["DCD poor", "Poor graft DCD" ] <-
  1 - total_trans_prob_DCD_poor


# From good graft DBD SCD
m_P_current_practice["Good graft DBD SCD", "Moderate graft DBD SCD" ] <-
  round(tp_gm_DBDSCD, 4)
m_P_current_practice["Good graft DBD SCD", "Poor graft DBD SCD"] <-
  round(tp_gp_DBDSCD, 4)
m_P_current_practice["Good graft DBD SCD", "Death w functioning graft" ] <-
  round(tp_gd_DBDSCD, 4)

trans_good_other <-
  m_P_current_practice["Good graft DBD SCD", "Moderate graft DBD SCD"] +
  m_P_current_practice["Good graft DBD SCD", "Poor graft DBD SCD"] +
  m_P_current_practice["Good graft DBD SCD", "Death w functioning graft"]

m_P_current_practice["Good graft DBD SCD", "Good graft DBD SCD"] <-
  1 - trans_good_other


# From moderate graft DBD SCD
m_P_current_practice["Moderate graft DBD SCD", "Poor graft DBD SCD"] <-
  round(tp_mp_DBDSCD, 4)
m_P_current_practice["Moderate graft DBD SCD", "Death w functioning graft" ] <-
  round(tp_md_DBDSCD, 4)

trans_moderate_other <-
  m_P_current_practice["Moderate graft DBD SCD", "Poor graft DBD SCD"] +
  m_P_current_practice["Moderate graft DBD SCD", "Death w functioning graft" ]

m_P_current_practice["Moderate graft DBD SCD", "Moderate graft DBD SCD" ] <-
  1 - trans_moderate_other


# From poor graft  DBD SCD
# Accumulating to the current value as you indicated
m_P_current_practice["Poor graft DBD SCD", "Off waitlist"] <-
  round(tp_graft_failure, 4)

m_P_current_practice["Poor graft DBD SCD", "Death after graft failure" ] <-
  round(tp_peskd_DBDSCD, 4)

m_P_current_practice["Poor graft DBD SCD", "Death w functioning graft" ] <-
  round(tp_pd_DBDSCD, 4)

trans_poor_to_other <-
  m_P_current_practice["Poor graft DBD SCD", "Off waitlist" ] +
  m_P_current_practice["Poor graft DBD SCD", "Death after graft failure" ] +
  m_P_current_practice["Poor graft DBD SCD", "Death w functioning graft" ]

m_P_current_practice["Poor graft DBD SCD", "Poor graft DBD SCD" ] <-
  1 - trans_poor_to_other


# From good graft DBD ECD
m_P_current_practice["Good graft DBD ECD", "Moderate graft DBD ECD" ] <-
  round(tp_gm_DBDECD, 4)
m_P_current_practice["Good graft DBD ECD", "Poor graft DBD ECD"] <-
  round(tp_gp_DBDECD, 4)
m_P_current_practice["Good graft DBD ECD", "Death w functioning graft" ] <-
  round(tp_gd_DBDECD, 4)

trans_good_other <-
  m_P_current_practice["Good graft DBD ECD", "Moderate graft DBD ECD"] +
  m_P_current_practice["Good graft DBD ECD", "Poor graft DBD ECD"] +
  m_P_current_practice["Good graft DBD ECD", "Death w functioning graft"]

m_P_current_practice["Good graft DBD ECD", "Good graft DBD ECD"] <-
  1 - trans_good_other


# From moderate graft DBD ECD
m_P_current_practice["Moderate graft DBD ECD", "Poor graft DBD ECD"] <-
  round(tp_mp_DBDECD, 4)
m_P_current_practice["Moderate graft DBD ECD", "Death w functioning graft" ] <-
  round(tp_md_DBDECD, 4)

trans_moderate_other <-
  m_P_current_practice["Moderate graft DBD ECD", "Poor graft DBD ECD"] +
  m_P_current_practice["Moderate graft DBD ECD", "Death w functioning graft" ]

m_P_current_practice["Moderate graft DBD ECD", "Moderate graft DBD ECD" ] <-
  1 - trans_moderate_other


# From poor graft  DBD ECD
# Accumulating to the current value as you indicated
m_P_current_practice["Poor graft DBD ECD", "Off waitlist"] <-
  round(tp_graft_failure, 4)

m_P_current_practice["Poor graft DBD ECD", "Death after graft failure" ] <-
  round(tp_peskd_DBDECD, 4)

m_P_current_practice["Poor graft DBD ECD", "Death w functioning graft" ] <-
  round(tp_pd_DBDECD, 4)

trans_poor_to_other <-
  m_P_current_practice["Poor graft DBD ECD", "Off waitlist" ] +
  m_P_current_practice["Poor graft DBD ECD", "Death after graft failure" ] +
  m_P_current_practice["Poor graft DBD ECD", "Death w functioning graft" ]

m_P_current_practice["Poor graft DBD ECD", "Poor graft DBD ECD" ] <-
  1 - trans_poor_to_other


# From good graft DCD
m_P_current_practice["Good graft DCD", "Moderate graft DCD" ] <-
  round(tp_gm_DCD, 4)
m_P_current_practice["Good graft DCD", "Poor graft DCD"] <-
  round(tp_gp_DCD, 4)
m_P_current_practice["Good graft DCD", "Death w functioning graft" ] <-
  round(tp_gd_DCD, 4)

trans_good_other <-
  m_P_current_practice["Good graft DCD", "Moderate graft DCD"] +
  m_P_current_practice["Good graft DCD", "Poor graft DCD"] +
  m_P_current_practice["Good graft DCD", "Death w functioning graft"]

m_P_current_practice["Good graft DCD", "Good graft DCD"] <-
  1 - trans_good_other


# From moderate graft DCD
m_P_current_practice["Moderate graft DCD", "Poor graft DCD"] <-
  round(tp_mp_DCD, 4)
m_P_current_practice["Moderate graft DCD", "Death w functioning graft" ] <-
  round(tp_md_DCD, 4)

trans_moderate_other <-
  m_P_current_practice["Moderate graft DCD", "Poor graft DCD"] +
  m_P_current_practice["Moderate graft DCD", "Death w functioning graft" ]

m_P_current_practice["Moderate graft DCD", "Moderate graft DCD" ] <-
  1 - trans_moderate_other


# From poor graft  DCD
# Accumulating to the current value as you indicated
m_P_current_practice["Poor graft DCD", "Off waitlist"] <-
  round(tp_graft_failure, 4)

m_P_current_practice["Poor graft DCD", "Death after graft failure" ] <-
  round(tp_peskd_DCD, 4)

m_P_current_practice["Poor graft DCD", "Death w functioning graft" ] <-
  round(tp_pd_DCD, 4)

trans_poor_to_other <-
  m_P_current_practice["Poor graft DCD", "Off waitlist" ] +
  m_P_current_practice["Poor graft DCD", "Death after graft failure" ] +
  m_P_current_practice["Poor graft DCD", "Death w functioning graft" ]

m_P_current_practice["Poor graft DCD", "Poor graft DCD" ] <-
  1 - trans_poor_to_other


# From temporary off-waitlist
## Transition to death on dialysis
m_P_current_practice["Off waitlist", "Death off waitlist"] <-
  n_death_off_waitlist

## Transition back to the waitlist
m_P_current_practice["Off waitlist", "On waitlist"] <-
  round(tp_back_on_waitlist, 3)

## Calculating the remaining probability after accounting for death and transition back to the waitlist
total_trans_prob_off_waitlist <-
  round(m_P_current_practice["Off waitlist", "Death off waitlist"] + (m_P_current_practice["Off waitlist", "On waitlist"]), 3)

m_P_current_practice["Off waitlist", "Off waitlist"] <-
  
  1 - total_trans_prob_off_waitlist

# From HIV
## Death with functioning graft
m_P_current_practice["HIV", "Death w functioning graft"] <- n_death_functioning_graft


## people who remain in HIV
m_P_current_practice["HIV", "HIV" ] <- 1 - round(m_P_current_practice["HIV", "Death w functioning graft"], 3)


# From HBV
## from HBV to death from other causes
m_P_current_practice["HBV", "Death w functioning graft"] <-
  n_death_functioning_graft

## HBV to compensated cirrhosis
m_P_current_practice["HBV", "Hep B Comp cirr"] <- round(tp_chb_cc_hepB, 5)

## HBV to spontaneous clearance
m_P_current_practice["HBV", "Spon clearance"] <- round(tp_chb_sAgloss_hepB, 4) 

## HBV to hepatocellular carcinoma
m_P_current_practice["HBV", "Hep B HCC"] <- round(tp_chb_hcc, 7) 

trans_HBV_other <-
  m_P_current_practice["HBV", "Death w functioning graft"] +
  m_P_current_practice["HBV", "Hep B Comp cirr"] +
  m_P_current_practice["HBV", "Spon clearance"] +
  m_P_current_practice["HBV", "Hep B HCC"]

m_P_current_practice["HBV", "HBV"] <-
  1 - trans_HBV_other


# From HCV
## From HCV to death from other causes
m_P_current_practice["HCV", "Death w functioning graft"] <-
  n_death_functioning_graft

## from HCV to compensated cirrhosis
m_P_current_practice["HCV", "Hep C comp cirr"] <- round(tp_chc_cc_hepC, 5)

## from HCV to sustained virological response
m_P_current_practice["HCV", "SVR"] <- round(tp_SVR, 3)

trans_hcv_other <-
  m_P_current_practice["HCV", "Death w functioning graft"] +
  m_P_current_practice["HCV", "Hep C comp cirr"] +
  m_P_current_practice["HCV", "SVR"]

## people who continue to remain in HCV
m_P_current_practice["HCV", "HCV"] <-
  1 - trans_hcv_other



# From compensated cirrhosis Hep B
## From compensated cirrhosis to death from other causes
m_P_current_practice["Hep B Comp cirr", "Death w functioning graft"] <-
  n_death_functioning_graft

## from compensated cirrhosis to death due to end stage liver disease
m_P_current_practice["Hep B Comp cirr", "Death end stage liver"] <- round(tp_death_cc_hepB, 5)

## from compensated cirrhosis to decompensated cirrhosis
m_P_current_practice["Hep B Comp cirr", "Hep B Decomp cirr"] <- round(tp_cc_dc_hepB, 4)

## from compensated cirrhosis to hepatocellular carcinoma
m_P_current_practice["Hep B Comp cirr", "Hep B HCC"] <- round(tp_cc_hcc_hepB, 4)

trans_comp_hepB <-
  m_P_current_practice["Hep B Comp cirr", "Death w functioning graft"] +
  m_P_current_practice["Hep B Comp cirr", "Death end stage liver"] +
  m_P_current_practice["Hep B Comp cirr", "Hep B Decomp cirr"] +
  m_P_current_practice["Hep B Comp cirr", "Hep B HCC"]

m_P_current_practice["Hep B Comp cirr", "Hep B Comp cirr"] <-
  1 - trans_comp_hepB



# From compensated cirrhosis Hep C
## From compensated cirrhosis to death from other causes
m_P_current_practice["Hep C comp cirr", "Death w functioning graft"] <-
  n_death_functioning_graft

## from compensated cirrhosis to decompensated cirrhosis
m_P_current_practice["Hep C comp cirr", "Hep C Decomp cirr"] <- round(tp_cc_dc_hepC, 4)

## from compensated cirrhosis to hepatocellular carcinoma
m_P_current_practice["Hep C comp cirr", "Hep C HCC"] <- round(tp_cc_hcc_hepC, 4)

trans_comp_hepC <-
  m_P_current_practice["Hep C comp cirr", "Death w functioning graft"] +
  m_P_current_practice["Hep C comp cirr", "Hep C Decomp cirr"] +
  m_P_current_practice["Hep C comp cirr", "Hep C HCC"]

m_P_current_practice["Hep C comp cirr", "Hep C comp cirr"] <-
  1 - trans_comp_hepC


# From decompensated cirrhosis Hep B
## From decompensated cirrhosis to death from other causes
m_P_current_practice["Hep B Decomp cirr", "Death w functioning graft"] <-
  n_death_functioning_graft

## from decompemnsated cirrhosis to death due to end stage liver disease
m_P_current_practice["Hep B Decomp cirr", "Death end stage liver"] <- round(tp_death_dc_hepB, 4)

## from decompensated cirrhosis to hepatocellular carcinoma
m_P_current_practice["Hep B Decomp cirr", "Hep B HCC"] <- round(tp_dc_hcc_hepB, 4)

## from deoompensated cirrhosis to liver transplant
m_P_current_practice["Hep B Decomp cirr", "Liver transplant 3"] <- round(tp_dc_lt_hepB, 4)

trans_decom_hepB <-
  m_P_current_practice["Hep B Decomp cirr", "Death w functioning graft"] +
  m_P_current_practice["Hep B Decomp cirr", "Death end stage liver"] +
  m_P_current_practice["Hep B Decomp cirr", "Hep B HCC"] +
  m_P_current_practice["Hep B Decomp cirr", "Liver transplant 3"]

## people who continue to remain in decompensated cirrhosis
m_P_current_practice["Hep B Decomp cirr", "Hep B Decomp cirr"] <-
  1 - trans_decom_hepB



# From decompensated cirrhosis Hep C
## From decompensated cirrhosis to death from other causes
m_P_current_practice["Hep C Decomp cirr", "Death w functioning graft"] <-
  n_death_functioning_graft

## from decompemnsated cirrhosis to death due to end stage liver disease
m_P_current_practice["Hep C Decomp cirr", "Death end stage liver"] <- round(tp_death_dc_hepC, 4)

## from decompensated cirrhosis to hepatocellular carcinoma
m_P_current_practice["Hep C Decomp cirr", "Hep C HCC"] <- round(tp_dc_hcc_hepC, 4)

## from decompensated cirrhosis to liver transplant
m_P_current_practice["Hep C Decomp cirr", "Liver transplant 3"] <- round(tp_dc_lt_hepC, 4)

trans_decom_hepC <-
  m_P_current_practice["Hep C Decomp cirr", "Death w functioning graft"] +
  m_P_current_practice["Hep C Decomp cirr", "Death end stage liver"] +
  m_P_current_practice["Hep C Decomp cirr", "Hep C HCC"] +
  m_P_current_practice["Hep C Decomp cirr", "Liver transplant 3"]

m_P_current_practice["Hep C Decomp cirr", "Hep C Decomp cirr"] <-
  1 - trans_decom_hepC



# From hepatocellular carcinoma Hep B
## from hepatocellular carcinoma to death from other causes
m_P_current_practice["Hep B HCC", "Death w functioning graft"] <-
  n_death_functioning_graft

## from hepatocellular carcinoma to death due to end stage liver disease
m_P_current_practice["Hep B HCC", "Death end stage liver"] <-
  round(tp_death_hcc_hepB, 4)

## from hepatocellular carcinoma to liver transplant
m_P_current_practice["Hep B HCC", "Liver transplant 3"] <- round(tp_hcc_lt_hepB, 4)

trans_hcc_hepB <-
  m_P_current_practice["Hep B HCC", "Death w functioning graft"] +
  m_P_current_practice["Hep B HCC", "Death end stage liver"] +
  m_P_current_practice["Hep B HCC", "Liver transplant 3"]

m_P_current_practice["Hep B HCC", "Hep B HCC"] <-
  1 - trans_hcc_hepB



# From hepatocellular carcinoma Hep C
## from hepatocellular carcinoma to death from other causes
m_P_current_practice["Hep C HCC", "Death w functioning graft" ] <-
  n_death_functioning_graft

## from hepatocellular carcinoma to death due to end stage liver disease
m_P_current_practice["Hep C HCC", "Death end stage liver"] <-
  round(tp_death_hcc_hepC, 4)

## from hepatocellular carcinoma to liver transplant
m_P_current_practice["Hep C HCC", "Liver transplant 3"] <-
  round(tp_hcc_lt_hepC, 4)

trans_hcc_hepC <-
  m_P_current_practice["Hep C HCC", "Death w functioning graft"] +
  m_P_current_practice["Hep C HCC", "Death end stage liver"] +
  m_P_current_practice["Hep C HCC", "Liver transplant 3"]

m_P_current_practice["Hep C HCC", "Hep C HCC"] <-
  1 - trans_hcc_hepC



# From spontaneous clearance
## from spon clearance to death from other causes
m_P_current_practice["Spon clearance", "Death w functioning graft"] <-
  n_death_functioning_graft

trans_sponclear <-
  m_P_current_practice["Spon clearance", "Death w functioning graft"]

m_P_current_practice["Spon clearance", "Spon clearance"] <-
  1 - trans_sponclear



# From SVR
## from SVR to death from other causes
m_P_current_practice["SVR", "Death w functioning graft"] <-
  n_death_functioning_graft

trans_svr <-
  m_P_current_practice["SVR", "Death w functioning graft"]

m_P_current_practice["SVR", "SVR"] <- 1 - trans_svr



# From liver transplant
## Liver transplant year 1: 3 months
m_P_current_practice["Liver transplant 3", "Death end stage liver"] <-
  round(tp_death_LT, 4)

total_outgoing <-
  m_P_current_practice["Liver transplant 3", "Death end stage liver"]

m_P_current_practice["Liver transplant 3", "Liver transplant 6"] <-
  1 - total_outgoing


## from LT 6 to death
m_P_current_practice["Liver transplant 6", "Death end stage liver"] <-
  round(tp_death_LT, 4)

total_outgoing <-
  m_P_current_practice["Liver transplant 6", "Death end stage liver"]


m_P_current_practice["Liver transplant 6", "Liver transplant 9"] <-
  1 - total_outgoing



# from LT 9 to death
m_P_current_practice["Liver transplant 9", "Death end stage liver"] <-
  round(tp_death_LT, 4)

total_outgoing <-
  m_P_current_practice["Liver transplant 9", "Death end stage liver"]

m_P_current_practice["Liver transplant 9", "Liver transplant 12"] <-
  1 - total_outgoing



# from LT 12 to death
m_P_current_practice["Liver transplant 12", "Death end stage liver"] <-
  round(tp_death_LT, 4)

total_outgoing <-
  m_P_current_practice["Liver transplant 12", "Death end stage liver"]

m_P_current_practice["Liver transplant 12", "Liver transplant yr 2"] <-
  1 - total_outgoing



## Liver transplant Year 2+
# Transition from "Liver transplant yr 2" to "Death end stage liver"
m_P_current_practice["Liver transplant yr 2", "Death end stage liver"] <-
  round(tp_death_LT, 4)

trans_lt2 <-
  m_P_current_practice["Liver transplant yr 2", "Death end stage liver"]

m_P_current_practice["Liver transplant yr 2", "Liver transplant yr 2"] <-
  1 - trans_lt2



#Death
m_P_current_practice["Death on waitlist", "Death on waitlist"] <- 1

m_P_current_practice["Death off waitlist", "Death off waitlist"] <-  1

m_P_current_practice["Death w functioning graft", "Death w functioning graft"] <- 1

m_P_current_practice["Death after graft failure", "Death after graft failure"] <-  1

m_P_current_practice["Death end stage liver", "Death end stage liver"] <-
  1



#iterative solution of time independent cohort model
for (t in 1:n_cycles) {
  # Current practice
  m_M_current_practice[t + 1, ] <-
    m_M_current_practice[t, ] %*% m_P_current_practice
}


# Create aggregated traces
m_M_current_practice_sum <-
  cbind(
    Waitlist = m_M_current_practice[, "On waitlist"],
    DBD_SCD_good = m_M_current_practice[, "DBD SCD good"],
    DBD_SCD_moderate = m_M_current_practice[,"DBD SCD moderate"],
    DBD_SCD_poor = m_M_current_practice[,"DBD SCD poor"],
    DBD_ECD_good =  m_M_current_practice[, "DBD ECD good"],
    DBD_ECD_moderate = m_M_current_practice[, "DBD ECD moderate"],
    DBD_ECD_poor = m_M_current_practice[, "DBD ECD poor"],
    DCD_good = m_M_current_practice[, "DCD good"],
    DCD_moderate = m_M_current_practice[, "DCD moderate"],
    DCD_poor = m_M_current_practice[, "DCD poor"],
    gg_DBD_SCD =  m_M_current_practice[, "Good graft DBD SCD"],
    mg_DBD_SCD =  m_M_current_practice[, "Moderate graft DBD SCD"],
    pg_DBD_SCD =  m_M_current_practice[, "Poor graft DBD SCD"],
    gg_DBD_ECD =  m_M_current_practice[, "Good graft DBD ECD"],
    mg_DBD_ECD =  m_M_current_practice[, "Moderate graft DBD ECD"],
    pg_DBD_ECD =  m_M_current_practice[, "Poor graft DBD ECD"],
    gg_DCD =  m_M_current_practice[, "Good graft DCD"],
    mg_DCD =  m_M_current_practice[, "Moderate graft DCD"],
    pg_DCD =  m_M_current_practice[, "Poor graft DCD"],
    Off_waitlist = m_M_current_practice[, "Off waitlist"],
    Good_graft = m_M_current_practice[, "Good graft DCD"] +
      m_M_current_practice[, "Good graft DBD SCD"] +
      m_M_current_practice[, "Good graft DBD ECD"],
    Moderate_graft = m_M_current_practice[, "Moderate graft DCD"] +
      m_M_current_practice[, "Moderate graft DBD SCD"] +
      m_M_current_practice[, "Moderate graft DBD ECD"],
    Poor_graft = m_M_current_practice[, "Poor graft DCD"] +
      m_M_current_practice[, "Poor graft DBD SCD"] +
      m_M_current_practice[, "Poor graft DBD ECD"],
    HIV = m_M_current_practice[, "HIV"],
    HBV = m_M_current_practice[, "HBV"],
    HCV = m_M_current_practice[, "HCV"],
    HepB_Comp_cirr = m_M_current_practice[, "Hep B Comp cirr"],
    HepC_Comp_cirr = m_M_current_practice[, "Hep C comp cirr"],
    HepB_Decomp_cirr = m_M_current_practice[, "Hep B Decomp cirr"],
    HepC_Decomp_cirr = m_M_current_practice[, "Hep C Decomp cirr"],
    HepB_HCC = m_M_current_practice[, "Hep B HCC"],
    HepC_HCC = m_M_current_practice[, "Hep C HCC"],
    Spon_clear = m_M_current_practice[, "Spon clearance"],
    SVR = m_M_current_practice[, "SVR"],
    Liver_trans_1yr = m_M_current_practice[, "Liver transplant 3"] +
      m_M_current_practice[, "Liver transplant 6"] +
      m_M_current_practice[, "Liver transplant 9"] +
      m_M_current_practice[, "Liver transplant 12"],
    Liver_trans_2yr = m_M_current_practice[, "Liver transplant yr 2"],
    Death_waitlist = m_M_current_practice[, "Death on waitlist"],
    Death_off_waitlist = m_M_current_practice[, "Death off waitlist"],
    Death_after_graft_failure = m_M_current_practice[, "Death after graft failure"],
    Death_w_functioning_graft = m_M_current_practice[, "Death w functioning graft"],
    Death_liver = m_M_current_practice[, "Death end stage liver"]
)
current_practice <- data.frame(m_M_current_practice_sum)

current_practice <- current_practice %>%
  add_column(Stage = 0:80)

# current_practice <- current_practice %>%
#   mutate(Transplant = rowSums(select(., DBD_SCD, DBD_ECD, DCD)))

# 
write_xlsx(
  current_practice,
  "C:/Users/kshah/OneDrive - The University of Sydney (Staff)/Markov vs microsim/Model/Markov model/R/Model deconstruction/current_practice_R.xlsx"
)

```   


# Decons - Fill in the matrix for proposed practice
```{r}
### Initialize transition probability matrix for strategy current practice ----
#* All transitions to a non-death state are assumed to be conditional on survival 

# From waitlist
m_P_proposed_practice["On waitlist", "Death on waitlist"] <-
  n_death_waitlist

# Calculate transitions for transplant and suspension using blood group proportions
bloodgrp_transition_transplant_DBDSCD = round(calculate_bloodgrp_transitions_transplant(tp_transplant, pro_blood_grp) * pro_DBDSCD, 3)
bloodgrp_transition_transplant_DBDECD = round(calculate_bloodgrp_transitions_transplant(tp_transplant, pro_blood_grp) * pro_DBDECD, 3)
bloodgrp_transition_transplant_DCD = round(calculate_bloodgrp_transitions_transplant(tp_transplant, pro_blood_grp) * pro_DCD, 3)

bloodgrp_transition_suspension_DBDSCD = round(calculate_bloodgrp_transitions_suspension(tp_suspension, pro_blood_grp) * pro_DBDSCD, 3)
bloodgrp_transition_suspension_DBDECD = round(calculate_bloodgrp_transitions_suspension(tp_suspension, pro_blood_grp) * pro_DBDECD, 3)
bloodgrp_transition_suspension_DCD = round(calculate_bloodgrp_transitions_suspension(tp_suspension, pro_blood_grp) * pro_DCD, 3)
proposed_pol_suspen <- round(per_effect_increased_risk_behaviours * tp_graft_failure, 3)

susp_prob <- bloodgrp_transition_suspension_DBDSCD + bloodgrp_transition_suspension_DBDECD + bloodgrp_transition_suspension_DCD

tx_fail_to_off_wlst <-  round(bloodgrp_transition_transplant_DBDSCD * tp_graft_failure +
  bloodgrp_transition_transplant_DBDECD * tp_graft_failure +
  bloodgrp_transition_transplant_DCD * tp_graft_failure, 4)
 
# Transitions to transplant states
m_P_proposed_practice["On waitlist", "DBD SCD good"] <-
 round(bloodgrp_transition_transplant_DBDSCD * (1 - pro_DBDSCD_mg - pro_DBDSCD_pg - tp_graft_failure), 4) +
   round(per_effect_increased_risk_behaviours * (1 - pro_DBDSCD_mg - pro_DBDSCD_pg - tp_graft_failure), 4) 

m_P_proposed_practice["On waitlist", "DBD SCD moderate"] <-
 round(pro_DBDSCD_mg * bloodgrp_transition_transplant_DBDSCD, 4)  +
   round(pro_DBDSCD_mg * per_effect_increased_risk_behaviours, 4) 

m_P_proposed_practice["On waitlist", "DBD SCD poor"] <-
 round(pro_DBDSCD_pg * bloodgrp_transition_transplant_DBDSCD, 4) +
  round(pro_DBDSCD_pg * per_effect_increased_risk_behaviours, 4) 


m_P_proposed_practice["On waitlist", "DBD ECD good"] <-
 round(bloodgrp_transition_transplant_DBDECD * (1 - pro_DBDECD_mg - pro_DBDECD_pg - tp_graft_failure), 4)

m_P_proposed_practice["On waitlist", "DBD ECD moderate"] <-
 round(pro_DBDECD_mg * bloodgrp_transition_transplant_DBDECD, 4)

m_P_proposed_practice["On waitlist", "DBD ECD poor"] <-
 round(pro_DBDECD_pg * bloodgrp_transition_transplant_DBDECD, 4)


m_P_proposed_practice["On waitlist", "DCD good"] <-
 round(bloodgrp_transition_transplant_DCD * (1 - pro_DCD_mg - pro_DCD_pg - tp_graft_failure), 4)

m_P_proposed_practice["On waitlist", "DCD moderate"] <-
 round(pro_DCD_mg * bloodgrp_transition_transplant_DCD, 4)

m_P_proposed_practice["On waitlist", "DCD poor"] <-
 round(pro_DCD_pg * bloodgrp_transition_transplant_DCD, 4)


m_P_proposed_practice["On waitlist", "HCV"] <- per_effect_hcv


m_P_proposed_practice["On waitlist", "Off waitlist"] <- 
 round(susp_prob + tx_fail_to_off_wlst + proposed_pol_suspen, 4)
  


# Sum of all transitions out of the current waitlist state
total_trans_prob =
  m_P_proposed_practice["On waitlist", "Death on waitlist"] +
  m_P_proposed_practice["On waitlist", "DBD SCD good"] +
  m_P_proposed_practice["On waitlist", "DBD SCD moderate"] +
  m_P_proposed_practice["On waitlist", "DBD SCD poor"] +
  m_P_proposed_practice["On waitlist", "DBD ECD good"] +
  m_P_proposed_practice["On waitlist", "DBD ECD moderate"] +
  m_P_proposed_practice["On waitlist", "DBD ECD poor"] +
  m_P_proposed_practice["On waitlist", "DCD good"] +
  m_P_proposed_practice["On waitlist", "DCD moderate"] +
  m_P_proposed_practice["On waitlist", "DCD poor"] +
  m_P_proposed_practice["On waitlist", "HCV"] +
  m_P_proposed_practice["On waitlist", "Off waitlist"]

m_P_proposed_practice["On waitlist", "On waitlist"] <-   round(1 - total_trans_prob, 5)


# From kidney transplant
## DBD SCD good
### to HIV
m_P_proposed_practice["DBD SCD good", "HIV" ] <-
  round(tp_HIV_proposed_practice, 7) 

### to hepatitis B
m_P_proposed_practice["DBD SCD good", "HBV" ] <-
  round(tp_HBV_proposed_practice, 4) 

### to hepatitis C
m_P_proposed_practice["DBD SCD good", "HCV" ] <-
  round(tp_HCV_proposed_practice, 5) 

total_trans_prob_DBDSCD_good =
  m_P_proposed_practice["DBD SCD good", "HIV" ] +
  m_P_proposed_practice["DBD SCD good", "HBV" ] +
  m_P_proposed_practice["DBD SCD good", "HCV"] 

### good graft function post kidney transplant. All the remaining patients would move here.
m_P_proposed_practice["DBD SCD good", "Good graft DBD SCD"] <-
  1 - total_trans_prob_DBDSCD_good


## DBD SCD moderate
### to HIV
m_P_proposed_practice["DBD SCD moderate", "HIV" ] <-
  round(tp_HIV_proposed_practice, 7) 

### to hepatitis B
m_P_proposed_practice["DBD SCD moderate", "HBV"] <-
  round(tp_HBV_proposed_practice, 4)  

### to hepatitis C
m_P_proposed_practice["DBD SCD moderate", "HCV" ] <-
round(tp_HCV_proposed_practice, 5)

total_trans_prob_DBDSCD_moderate =
  m_P_proposed_practice["DBD ECD moderate", "HIV" ] +
  m_P_proposed_practice["DBD SCD moderate", "HBV"] +
  m_P_proposed_practice["DBD SCD moderate", "HCV"]

### good graft function post kidney transplant. All the remaining patients would move here.
m_P_proposed_practice["DBD SCD moderate", "Moderate graft DBD SCD"] <-
  1 - total_trans_prob_DBDSCD_moderate



## DBD SCD poor
### to HIV
m_P_proposed_practice["DBD SCD poor", "HIV" ] <-
  round(tp_HIV_proposed_practice, 7) 

### to hepatitis B
m_P_proposed_practice["DBD SCD poor", "HBV" ] <-
  round(tp_HBV_proposed_practice, 4)   

### to hepatitis C
m_P_proposed_practice["DBD SCD poor", "HCV" ] <-
round(tp_HCV_proposed_practice, 5)

total_trans_prob_DBDSCD_poor =
  m_P_proposed_practice["DBD SCD poor", "HIV" ] +
  m_P_proposed_practice["DBD SCD poor", "HBV"] +
  m_P_proposed_practice["DBD SCD poor", "HCV" ] 

### good graft function post kidney transplant. All the remaining patients would move here.
m_P_proposed_practice["DBD SCD poor", "Poor graft DBD SCD" ] <-
  1 - total_trans_prob_DBDSCD_poor


## From DBD ECD good
### to HIV
m_P_proposed_practice["DBD ECD good", "HIV" ] <-
  round(tp_HIV_proposed_practice, 7)

### to hepatitis B
m_P_proposed_practice["DBD ECD good", "HBV"] <-
  round(tp_HBV_proposed_practice, 4)  

### to hepatitis C
m_P_proposed_practice["DBD ECD good", "HCV"] <-
 round(tp_HCV_proposed_practice, 5)

total_trans_prob_DBDECD_good =
  m_P_proposed_practice["DBD ECD good", "HIV" ] +
  m_P_proposed_practice["DBD ECD good", "HBV"] +
  m_P_proposed_practice["DBD ECD good", "HCV"]

### good graft function post kidney transplant. All the remaining patients would move here.
m_P_proposed_practice["DBD ECD good", "Good graft DBD ECD"] <-
  1 - total_trans_prob_DBDECD_good


## From DBD ECD moderate
### to HIV
m_P_proposed_practice["DBD ECD moderate", "HIV" ] <-
  round(tp_HIV_proposed_practice, 7)

### to hepatitis B
m_P_proposed_practice["DBD ECD moderate", "HBV" ] <-
  round(tp_HBV_proposed_practice, 4)  

### to hepatitis C
m_P_proposed_practice["DBD ECD moderate", "HCV" ] <-
  round(tp_HCV_proposed_practice, 5)

total_trans_prob_DBDECD_moderate =
  m_P_proposed_practice["DBD ECD moderate", "HIV" ] +
  m_P_proposed_practice["DBD ECD moderate", "HBV"] +
  m_P_proposed_practice["DBD ECD moderate", "HCV"] 

### moderate graft function post kidney transplant. All the remaining patients would move here.
m_P_proposed_practice["DBD ECD moderate", "Moderate graft DBD ECD"] <-
  1 - total_trans_prob_DBDECD_moderate


## From DBD ECD poor
### to HIV
m_P_proposed_practice["DBD ECD poor", "HIV" ] <-
  round(tp_HIV_proposed_practice, 7)

### to hepatitis B
m_P_proposed_practice["DBD ECD poor", "HBV" ] <-
   round(tp_HBV_proposed_practice, 4)  

### to hepatitis C
m_P_proposed_practice["DBD ECD poor", "HCV"] <-
  round(tp_HCV_proposed_practice, 5)

total_trans_prob_DBDECD_poor =
  m_P_proposed_practice["DBD ECD poor", "HIV" ] +
  m_P_proposed_practice["DBD ECD poor", "HBV" ] +
  m_P_proposed_practice["DBD ECD poor", "HCV" ]

### poor graft function post kidney transplant. All the remaining patients would move here.
m_P_proposed_practice["DBD ECD poor", "Poor graft DBD ECD"] <-
  1 - total_trans_prob_DBDECD_poor


## From DCD good
### to HIV
m_P_proposed_practice["DCD good", "HIV" ] <-
  round(tp_HIV_proposed_practice, 7)

### to hepatitis B
m_P_proposed_practice["DCD good", "HBV"] <-
   round(tp_HBV_proposed_practice, 4)   

### to hepatitis C
m_P_proposed_practice["DCD good", "HCV" ] <-
  round(tp_HCV_proposed_practice, 5) 

total_trans_prob_DCD_good =
  m_P_proposed_practice["DCD good", "HIV" ] +
  m_P_proposed_practice["DCD good", "HBV" ] +
  m_P_proposed_practice["DCD good", "HCV" ] 

### good graft function post kidney transplant. All the remaining patients would move here.
m_P_proposed_practice["DCD good", "Good graft DCD" ] <-
  1 - total_trans_prob_DCD_good


## From DCD moderate
### to HIV
m_P_proposed_practice["DCD moderate", "HIV" ] <-
  round(tp_HIV_proposed_practice, 7)

### to hepatitis B
m_P_proposed_practice["DCD moderate", "HBV"] <-
   round(tp_HBV_proposed_practice, 4)   

### to hepatitis C
m_P_proposed_practice["DCD moderate", "HCV" ] <-
  round(tp_HCV_proposed_practice, 5)

total_trans_prob_DCD_moderate =
  m_P_proposed_practice["DCD moderate", "HIV" ] +
  m_P_proposed_practice["DCD moderate", "HBV" ] +
  m_P_proposed_practice["DCD moderate", "HCV" ]

### moderate graft function post kidney transplant. All the remaining patients would move here.
m_P_proposed_practice["DCD moderate", "Moderate graft DCD" ] <-
  1 - total_trans_prob_DCD_moderate


## From DCD poor
### to HIV
m_P_proposed_practice["DCD poor", "HIV" ] <-
  round(tp_HIV_proposed_practice, 7)

### to hepatitis B
m_P_proposed_practice["DCD poor", "HBV" ] <-
  round(tp_HBV_proposed_practice, 4)  
### to hepatitis C
m_P_proposed_practice["DCD poor", "HCV" ] <-
  round(tp_HCV_proposed_practice, 5)

total_trans_prob_DCD_poor =
  m_P_proposed_practice["DCD poor", "HIV" ] +
  m_P_proposed_practice["DCD poor", "HBV"] +
  m_P_proposed_practice["DCD poor", "HCV" ] 

### poor graft function post kidney transplant. All the remaining patients would move here.
m_P_proposed_practice["DCD poor", "Poor graft DCD" ] <-
  1 - total_trans_prob_DCD_poor


# From good graft DBD SCD
m_P_proposed_practice["Good graft DBD SCD", "Moderate graft DBD SCD" ] <-
  round(tp_gm_DBDSCD, 4)
m_P_proposed_practice["Good graft DBD SCD", "Poor graft DBD SCD"] <-
  round(tp_gp_DBDSCD, 4)
m_P_proposed_practice["Good graft DBD SCD", "Death w functioning graft" ] <-
  round(tp_gd_DBDSCD, 4)

trans_good_other <-
  m_P_proposed_practice["Good graft DBD SCD", "Moderate graft DBD SCD"] +
  m_P_proposed_practice["Good graft DBD SCD", "Poor graft DBD SCD"] +
  m_P_proposed_practice["Good graft DBD SCD", "Death w functioning graft"]

m_P_proposed_practice["Good graft DBD SCD", "Good graft DBD SCD"] <-
  1 - trans_good_other


# From moderate graft DBD SCD
m_P_proposed_practice["Moderate graft DBD SCD", "Poor graft DBD SCD"] <-
  round(tp_mp_DBDSCD, 4)
m_P_proposed_practice["Moderate graft DBD SCD", "Death w functioning graft" ] <-
  round(tp_md_DBDSCD, 4)

trans_moderate_other <-
  m_P_proposed_practice["Moderate graft DBD SCD", "Poor graft DBD SCD"] +
  m_P_proposed_practice["Moderate graft DBD SCD", "Death w functioning graft" ]

m_P_proposed_practice["Moderate graft DBD SCD", "Moderate graft DBD SCD" ] <-
  1 - trans_moderate_other


# From poor graft  DBD SCD
# Accumulating to the proposed value as you indicated
m_P_proposed_practice["Poor graft DBD SCD", "Off waitlist"] <-
  round(tp_graft_failure, 4)

m_P_proposed_practice["Poor graft DBD SCD", "Death after graft failure" ] <-
  round(tp_peskd_DBDSCD, 4)

m_P_proposed_practice["Poor graft DBD SCD", "Death w functioning graft" ] <-
  round(tp_pd_DBDSCD, 4)

trans_poor_to_other <-
  m_P_proposed_practice["Poor graft DBD SCD", "Off waitlist" ] +
  m_P_proposed_practice["Poor graft DBD SCD", "Death after graft failure" ] +
  m_P_proposed_practice["Poor graft DBD SCD", "Death w functioning graft" ]

m_P_proposed_practice["Poor graft DBD SCD", "Poor graft DBD SCD" ] <-
  1 - trans_poor_to_other


# From good graft DBD ECD
m_P_proposed_practice["Good graft DBD ECD", "Moderate graft DBD ECD" ] <-
  round(tp_gm_DBDECD, 4)
m_P_proposed_practice["Good graft DBD ECD", "Poor graft DBD ECD"] <-
  round(tp_gp_DBDECD, 4)
m_P_proposed_practice["Good graft DBD ECD", "Death w functioning graft" ] <-
  round(tp_gd_DBDECD, 4)

trans_good_other <-
  m_P_proposed_practice["Good graft DBD ECD", "Moderate graft DBD ECD"] +
  m_P_proposed_practice["Good graft DBD ECD", "Poor graft DBD ECD"] +
  m_P_proposed_practice["Good graft DBD ECD", "Death w functioning graft"]

m_P_proposed_practice["Good graft DBD ECD", "Good graft DBD ECD"] <-
  1 - trans_good_other


# From moderate graft DBD ECD
m_P_proposed_practice["Moderate graft DBD ECD", "Poor graft DBD ECD"] <-
  round(tp_mp_DBDECD, 4)
m_P_proposed_practice["Moderate graft DBD ECD", "Death w functioning graft" ] <-
  round(tp_md_DBDECD, 4)

trans_moderate_other <-
  m_P_proposed_practice["Moderate graft DBD ECD", "Poor graft DBD ECD"] +
  m_P_proposed_practice["Moderate graft DBD ECD", "Death w functioning graft" ]

m_P_proposed_practice["Moderate graft DBD ECD", "Moderate graft DBD ECD" ] <-
  1 - trans_moderate_other


# From poor graft  DBD ECD
# Accumulating to the proposed value as you indicated
m_P_proposed_practice["Poor graft DBD ECD", "Off waitlist"] <-
  round(tp_graft_failure, 4)

m_P_proposed_practice["Poor graft DBD ECD", "Death after graft failure" ] <-
  round(tp_peskd_DBDECD, 4)

m_P_proposed_practice["Poor graft DBD ECD", "Death w functioning graft" ] <-
  round(tp_pd_DBDECD, 4)

trans_poor_to_other <-
  m_P_proposed_practice["Poor graft DBD ECD", "Off waitlist" ] +
  m_P_proposed_practice["Poor graft DBD ECD", "Death after graft failure" ] +
  m_P_proposed_practice["Poor graft DBD ECD", "Death w functioning graft" ]

m_P_proposed_practice["Poor graft DBD ECD", "Poor graft DBD ECD" ] <-
  1 - trans_poor_to_other


# From good graft DCD
m_P_proposed_practice["Good graft DCD", "Moderate graft DCD" ] <-
  round(tp_gm_DCD, 4)
m_P_proposed_practice["Good graft DCD", "Poor graft DCD"] <-
  round(tp_gp_DCD, 4)
m_P_proposed_practice["Good graft DCD", "Death w functioning graft" ] <-
  round(tp_gd_DCD, 4)

trans_good_other <-
  m_P_proposed_practice["Good graft DCD", "Moderate graft DCD"] +
  m_P_proposed_practice["Good graft DCD", "Poor graft DCD"] +
  m_P_proposed_practice["Good graft DCD", "Death w functioning graft"]

m_P_proposed_practice["Good graft DCD", "Good graft DCD"] <-
  1 - trans_good_other


# From moderate graft DCD
m_P_proposed_practice["Moderate graft DCD", "Poor graft DCD"] <-
  round(tp_mp_DCD, 4)
m_P_proposed_practice["Moderate graft DCD", "Death w functioning graft" ] <-
  round(tp_md_DCD, 4)

trans_moderate_other <-
  m_P_proposed_practice["Moderate graft DCD", "Poor graft DCD"] +
  m_P_proposed_practice["Moderate graft DCD", "Death w functioning graft" ]

m_P_proposed_practice["Moderate graft DCD", "Moderate graft DCD" ] <-
  1 - trans_moderate_other


# From poor graft  DCD
# Accumulating to the proposed value as you indicated
m_P_proposed_practice["Poor graft DCD", "Off waitlist"] <-
  round(tp_graft_failure, 4)

m_P_proposed_practice["Poor graft DCD", "Death after graft failure" ] <-
  round(tp_peskd_DCD, 4)

m_P_proposed_practice["Poor graft DCD", "Death w functioning graft" ] <-
  round(tp_pd_DCD, 4)

trans_poor_to_other <-
  m_P_proposed_practice["Poor graft DCD", "Off waitlist" ] +
  m_P_proposed_practice["Poor graft DCD", "Death after graft failure" ] +
  m_P_proposed_practice["Poor graft DCD", "Death w functioning graft" ]

m_P_proposed_practice["Poor graft DCD", "Poor graft DCD" ] <-
  1 - trans_poor_to_other


# From temporary off-waitlist
## Transition to death on dialysis
m_P_proposed_practice["Off waitlist", "Death off waitlist"] <-
  n_death_off_waitlist

## Transition back to the waitlist
m_P_proposed_practice["Off waitlist", "On waitlist"] <-
  round(tp_back_on_waitlist, 3)

## Calculating the remaining probability after accounting for death and transition back to the waitlist
total_trans_prob_off_waitlist <-
  round(m_P_proposed_practice["Off waitlist", "Death off waitlist"] + (m_P_proposed_practice["Off waitlist", "On waitlist"]), 3)

m_P_proposed_practice["Off waitlist", "Off waitlist"] <-
  
  1 - total_trans_prob_off_waitlist

# From HIV
## Death with functioning graft
m_P_proposed_practice["HIV", "Death w functioning graft"] <- n_death_functioning_graft


## people who remain in HIV
m_P_proposed_practice["HIV", "HIV" ] <- 1 - round(m_P_proposed_practice["HIV", "Death w functioning graft"], 3)


# From HBV
## from HBV to death from other causes
m_P_proposed_practice["HBV", "Death w functioning graft"] <-
  n_death_functioning_graft

## HBV to compensated cirrhosis
m_P_proposed_practice["HBV", "Hep B Comp cirr"] <- round(tp_chb_cc_hepB, 5)

## HBV to spontaneous clearance
m_P_proposed_practice["HBV", "Spon clearance"] <- round(tp_chb_sAgloss_hepB, 4) 

## HBV to hepatocellular carcinoma
m_P_proposed_practice["HBV", "Hep B HCC"] <- round(tp_chb_hcc, 7) 

trans_HBV_other <-
  m_P_proposed_practice["HBV", "Death w functioning graft"] +
  m_P_proposed_practice["HBV", "Hep B Comp cirr"] +
  m_P_proposed_practice["HBV", "Spon clearance"] +
  m_P_proposed_practice["HBV", "Hep B HCC"]

m_P_proposed_practice["HBV", "HBV"] <-
  1 - trans_HBV_other


# From HCV
## From HCV to death from other causes
m_P_proposed_practice["HCV", "Death w functioning graft"] <-
  n_death_functioning_graft

## from HCV to compensated cirrhosis
m_P_proposed_practice["HCV", "Hep C comp cirr"] <- round(tp_chc_cc_hepC, 4)

## from HCV to sustained virological response
m_P_proposed_practice["HCV", "SVR"] <- tp_SVR

trans_hcv_other <-
  m_P_proposed_practice["HCV", "Death w functioning graft"] +
  m_P_proposed_practice["HCV", "Hep C comp cirr"] +
  m_P_proposed_practice["HCV", "SVR"]

## people who continue to remain in HCV
m_P_proposed_practice["HCV", "HCV"] <-
  1 - trans_hcv_other



# From compensated cirrhosis Hep B
## From compensated cirrhosis to death from other causes
m_P_proposed_practice["Hep B Comp cirr", "Death w functioning graft"] <-
  n_death_functioning_graft

## from compensated cirrhosis to death due to end stage liver disease
m_P_proposed_practice["Hep B Comp cirr", "Death end stage liver"] <- round(tp_death_cc_hepB, 5)

## from compensated cirrhosis to decompensated cirrhosis
m_P_proposed_practice["Hep B Comp cirr", "Hep B Decomp cirr"] <- round(tp_cc_dc_hepB, 4)

## from compensated cirrhosis to hepatocellular carcinoma
m_P_proposed_practice["Hep B Comp cirr", "Hep B HCC"] <- round(tp_cc_hcc_hepB, 4)

trans_comp_hepB <-
  m_P_proposed_practice["Hep B Comp cirr", "Death w functioning graft"] +
  m_P_proposed_practice["Hep B Comp cirr", "Death end stage liver"] +
  m_P_proposed_practice["Hep B Comp cirr", "Hep B Decomp cirr"] +
  m_P_proposed_practice["Hep B Comp cirr", "Hep B HCC"]

m_P_proposed_practice["Hep B Comp cirr", "Hep B Comp cirr"] <-
  1 - trans_comp_hepB



# From compensated cirrhosis Hep C
## From compensated cirrhosis to death from other causes
m_P_proposed_practice["Hep C comp cirr", "Death w functioning graft"] <-
  n_death_functioning_graft

## from compensated cirrhosis to decompensated cirrhosis
m_P_proposed_practice["Hep C comp cirr", "Hep C Decomp cirr"] <-round(tp_cc_dc_hepC, 4)

## from compensated cirrhosis to hepatocellular carcinoma
m_P_proposed_practice["Hep C comp cirr", "Hep C HCC"] <- round(tp_cc_hcc_hepC, 4)

trans_comp_hepC <-
  m_P_proposed_practice["Hep C comp cirr", "Death w functioning graft"] +
  m_P_proposed_practice["Hep C comp cirr", "Hep C Decomp cirr"] +
  m_P_proposed_practice["Hep C comp cirr", "Hep C HCC"]

m_P_proposed_practice["Hep C comp cirr", "Hep C comp cirr"] <-
  1 - trans_comp_hepC


# From decompensated cirrhosis Hep B
## From decompensated cirrhosis to death from other causes
m_P_proposed_practice["Hep B Decomp cirr", "Death w functioning graft"] <-
  n_death_functioning_graft

## from decompemnsated cirrhosis to death due to end stage liver disease
m_P_proposed_practice["Hep B Decomp cirr", "Death end stage liver"] <- round(tp_death_dc_hepB, 4)

## from decompensated cirrhosis to hepatocellular carcinoma
m_P_proposed_practice["Hep B Decomp cirr", "Hep B HCC"] <- round(tp_dc_hcc_hepB, 4)

## from deoompensated cirrhosis to liver transplant
m_P_proposed_practice["Hep B Decomp cirr", "Liver transplant 3"] <- round(tp_dc_lt_hepB, 4)

trans_decom_hepB <-
  m_P_proposed_practice["Hep B Decomp cirr", "Death w functioning graft"] +
  m_P_proposed_practice["Hep B Decomp cirr", "Death end stage liver"] +
  m_P_proposed_practice["Hep B Decomp cirr", "Hep B HCC"] +
  m_P_proposed_practice["Hep B Decomp cirr", "Liver transplant 3"]

## people who continue to remain in decompensated cirrhosis
m_P_proposed_practice["Hep B Decomp cirr", "Hep B Decomp cirr"] <-
  1 - trans_decom_hepB



# From decompensated cirrhosis Hep C
## From decompensated cirrhosis to death from other causes
m_P_proposed_practice["Hep C Decomp cirr", "Death w functioning graft"] <-
  n_death_functioning_graft

## from decompemnsated cirrhosis to death due to end stage liver disease
m_P_proposed_practice["Hep C Decomp cirr", "Death end stage liver"] <- round(tp_death_dc_hepC, 4)

## from decompensated cirrhosis to hepatocellular carcinoma
m_P_proposed_practice["Hep C Decomp cirr", "Hep C HCC"] <- round(tp_dc_hcc_hepC, 4)

## from decompensated cirrhosis to liver transplant
m_P_proposed_practice["Hep C Decomp cirr", "Liver transplant 3"] <- round(tp_dc_lt_hepC, 4)

trans_decom_hepC <-
  m_P_proposed_practice["Hep C Decomp cirr", "Death w functioning graft"] +
  m_P_proposed_practice["Hep C Decomp cirr", "Death end stage liver"] +
  m_P_proposed_practice["Hep C Decomp cirr", "Hep C HCC"] +
  m_P_proposed_practice["Hep C Decomp cirr", "Liver transplant 3"]

m_P_proposed_practice["Hep C Decomp cirr", "Hep C Decomp cirr"] <-
  1 - trans_decom_hepC



# From hepatocellular carcinoma Hep B
## from hepatocellular carcinoma to death from other causes
m_P_proposed_practice["Hep B HCC", "Death w functioning graft"] <-
  n_death_functioning_graft

## from hepatocellular carcinoma to death due to end stage liver disease
m_P_proposed_practice["Hep B HCC", "Death end stage liver"] <-
  round(tp_death_hcc_hepB, 4)

## from hepatocellular carcinoma to liver transplant
m_P_proposed_practice["Hep B HCC", "Liver transplant 3"] <- round(tp_hcc_lt_hepB, 4)

trans_hcc_hepB <-
  m_P_proposed_practice["Hep B HCC", "Death w functioning graft"] +
  m_P_proposed_practice["Hep B HCC", "Death end stage liver"] +
  m_P_proposed_practice["Hep B HCC", "Liver transplant 3"]

m_P_proposed_practice["Hep B HCC", "Hep B HCC"] <-
  1 - trans_hcc_hepB



# From hepatocellular carcinoma Hep C
## from hepatocellular carcinoma to death from other causes
m_P_proposed_practice["Hep C HCC", "Death w functioning graft" ] <-
  n_death_functioning_graft

## from hepatocellular carcinoma to death due to end stage liver disease
m_P_proposed_practice["Hep C HCC", "Death end stage liver"] <-
  round(tp_death_hcc_hepC, 4)

## from hepatocellular carcinoma to liver transplant
m_P_proposed_practice["Hep C HCC", "Liver transplant 3"] <-
  round(tp_hcc_lt_hepC, 4)

trans_hcc_hepC <-
  m_P_proposed_practice["Hep C HCC", "Death w functioning graft"] +
  m_P_proposed_practice["Hep C HCC", "Death end stage liver"] +
  m_P_proposed_practice["Hep C HCC", "Liver transplant 3"]

m_P_proposed_practice["Hep C HCC", "Hep C HCC"] <-
  1 - trans_hcc_hepC



# From spontaneous clearance
## from spon clearance to death from other causes
m_P_proposed_practice["Spon clearance", "Death w functioning graft"] <-
  n_death_functioning_graft

trans_sponclear <-
  m_P_proposed_practice["Spon clearance", "Death w functioning graft"]

m_P_proposed_practice["Spon clearance", "Spon clearance"] <-
  1 - trans_sponclear



# From SVR
## from SVR to death from other causes
m_P_proposed_practice["SVR", "Death w functioning graft"] <-
  n_death_functioning_graft

trans_svr <-
  m_P_proposed_practice["SVR", "Death w functioning graft"]

m_P_proposed_practice["SVR", "SVR"] <- 1 - trans_svr



# From liver transplant
## Liver transplant year 1: 3 months
m_P_proposed_practice["Liver transplant 3", "Death end stage liver"] <-
  round(tp_death_LT, 4)

total_outgoing <-
  m_P_proposed_practice["Liver transplant 3", "Death end stage liver"]

m_P_proposed_practice["Liver transplant 3", "Liver transplant 6"] <-
  1 - total_outgoing


## from LT 6 to death
m_P_proposed_practice["Liver transplant 6", "Death end stage liver"] <-
  round(tp_death_LT, 4)

total_outgoing <-
  m_P_proposed_practice["Liver transplant 6", "Death end stage liver"]


m_P_proposed_practice["Liver transplant 6", "Liver transplant 9"] <-
  1 - total_outgoing



# from LT 9 to death
m_P_proposed_practice["Liver transplant 9", "Death end stage liver" ] <-
  round(tp_death_LT, 4)

total_outgoing <-
  m_P_proposed_practice["Liver transplant 9", "Death end stage liver" ]

m_P_proposed_practice["Liver transplant 9", "Liver transplant 12"] <-
  1 - total_outgoing



# from LT 12 to death
m_P_proposed_practice["Liver transplant 12", "Death end stage liver"] <-
  round(tp_death_LT, 4)

total_outgoing <-
  m_P_proposed_practice["Liver transplant 12", "Death end stage liver" ]

m_P_proposed_practice["Liver transplant 12", "Liver transplant yr 2"] <-
  1 - total_outgoing



## Liver transplant Year 2+
# Transition from "Liver transplant yr 2" to "Death end stage liver"
m_P_proposed_practice["Liver transplant yr 2", "Death end stage liver"] <-
  round(tp_death_LT, 4)

trans_lt2 <-
  m_P_proposed_practice["Liver transplant yr 2", "Death end stage liver"]

m_P_proposed_practice["Liver transplant yr 2", "Liver transplant yr 2"] <-
  1 - trans_lt2



#Death
m_P_proposed_practice["Death on waitlist", "Death on waitlist"] <- 1

m_P_proposed_practice["Death off waitlist", "Death off waitlist"] <-  1

m_P_proposed_practice["Death w functioning graft", "Death w functioning graft"] <- 1

m_P_proposed_practice["Death after graft failure", "Death after graft failure"] <-  1

m_P_proposed_practice["Death end stage liver", "Death end stage liver"] <- 1


#iterative solution of time independent cohort model
for (t in 1:n_cycles) {
  # proposed practice
  m_M_proposed_practice[t + 1, ] <-
    m_M_proposed_practice[t, ] %*% m_P_proposed_practice
}


# Create aggregated traces
m_M_proposed_practice_sum <-
  cbind(
    Waitlist = m_M_proposed_practice[, "On waitlist"],
    DBD_SCD_good = m_M_proposed_practice[, "DBD SCD good"],
    DBD_SCD_moderate = m_M_proposed_practice[,"DBD SCD moderate"],
    DBD_SCD_poor = m_M_proposed_practice[,"DBD SCD poor"],
    DBD_ECD_good =  m_M_proposed_practice[, "DBD ECD good"],
    DBD_ECD_moderate = m_M_proposed_practice[, "DBD ECD moderate"],
    DBD_ECD_poor = m_M_proposed_practice[, "DBD ECD poor"],
    DCD_good = m_M_proposed_practice[, "DCD good"],
    DCD_moderate = m_M_proposed_practice[, "DCD moderate"],
    DCD_poor = m_M_proposed_practice[, "DCD poor"],
    gg_DBD_SCD =  m_M_proposed_practice[, "Good graft DBD SCD"],
    mg_DBD_SCD =  m_M_proposed_practice[, "Moderate graft DBD SCD"],
    pg_DBD_SCD =  m_M_proposed_practice[, "Poor graft DBD SCD"],
    gg_DBD_ECD =  m_M_proposed_practice[, "Good graft DBD ECD"],
    mg_DBD_ECD =  m_M_proposed_practice[, "Moderate graft DBD ECD"],
    pg_DBD_ECD =  m_M_proposed_practice[, "Poor graft DBD ECD"],
    gg_DCD =  m_M_proposed_practice[, "Good graft DCD"],
    mg_DCD =  m_M_proposed_practice[, "Moderate graft DCD"],
    pg_DCD =  m_M_proposed_practice[, "Poor graft DCD"],
    Off_waitlist = m_M_proposed_practice[, "Off waitlist"],
    Good_graft = m_M_proposed_practice[, "Good graft DCD"] +
      m_M_proposed_practice[, "Good graft DBD SCD"] +
      m_M_proposed_practice[, "Good graft DBD ECD"],
    Moderate_graft = m_M_proposed_practice[, "Moderate graft DCD"] +
      m_M_proposed_practice[, "Moderate graft DBD SCD"] +
      m_M_proposed_practice[, "Moderate graft DBD ECD"],
    Poor_graft = m_M_proposed_practice[, "Poor graft DCD"] +
      m_M_proposed_practice[, "Poor graft DBD SCD"] +
      m_M_proposed_practice[, "Poor graft DBD ECD"],
    HIV = m_M_proposed_practice[, "HIV"],
    HBV = m_M_proposed_practice[, "HBV"],
    HCV = m_M_proposed_practice[, "HCV"],
    HepB_Comp_cirr = m_M_proposed_practice[, "Hep B Comp cirr"],
    HepC_Comp_cirr = m_M_proposed_practice[, "Hep C comp cirr"],
    HepB_Decomp_cirr = m_M_proposed_practice[, "Hep B Decomp cirr"],
    HepC_Decomp_cirr = m_M_proposed_practice[, "Hep C Decomp cirr"],
    HepB_HCC = m_M_proposed_practice[, "Hep B HCC"],
    HepC_HCC = m_M_proposed_practice[, "Hep C HCC"],
    Spon_clear = m_M_proposed_practice[, "Spon clearance"],
    SVR = m_M_proposed_practice[, "SVR"],
    Liver_trans_1yr = m_M_proposed_practice[, "Liver transplant 3"] +
      m_M_proposed_practice[, "Liver transplant 6"] +
      m_M_proposed_practice[, "Liver transplant 9"] +
      m_M_proposed_practice[, "Liver transplant 12"],
    Liver_trans_2yr = m_M_proposed_practice[, "Liver transplant yr 2"],
    Death_waitlist = m_M_proposed_practice[, "Death on waitlist"],
    Death_off_waitlist = m_M_proposed_practice[, "Death off waitlist"],
    Death_after_graft_failure = m_M_proposed_practice[, "Death after graft failure"],
    Death_w_functioning_graft = m_M_proposed_practice[, "Death w functioning graft"],
    Death_liver = m_M_proposed_practice[, "Death end stage liver"]
)

proposed_practice <- data.frame(m_M_proposed_practice_sum)

proposed_practice <- proposed_practice %>%
  add_column(Stage = 0:80)

# 
write_xlsx(
  proposed_practice,
  "C:/Users/kshah/OneDrive - The University of Sydney (Staff)/Markov vs microsim/Model/Markov model/R/Model deconstruction/proposed_practice_R.xlsx"
)
```


# Vector of state utilities under current and proposed practice
```{r echo=FALSE}
# Create a named vector for v_names_on_waitlist
v_u <- c(
  Waitlist = u_on_waitlist_dialysis$Value,
  DBD_SCD_good = u_transplantation_gg_function$Value,
  DBD_SCD_moderate = u_transplantation_mg_function$Value,
  DBD_SCD_poor = u_transplantation_pg_function$Value,
  DBD_ECD_good = u_transplantation_gg_function$Value,
  DBD_ECD_moderate = u_transplantation_mg_function$Value,
  DBD_ECD_poor = u_transplantation_pg_function$Value,
  DCD_good = u_transplantation_gg_function$Value,
  DCD_moderate = u_transplantation_mg_function$Value,
  DCD_poor = u_transplantation_pg_function$Value,
  gg_DBD_SCD = 0,
  mg_DBD_SCD = 0,
  pg_DBD_SCD = 0,
  gg_DBD_ECD = 0,
  mg_DBD_ECD = 0,
  pg_DBD_ECD = 0,
  gg_DCD = 0,
  mg_DCD = 0,
  pg_DCD = 0,
  Off_waitlist = u_on_waitlist_dialysis$Value,
  Good_graft = u_transplantation_gg_function$Value,
  Moderate_graft = u_transplantation_mg_function$Value,
  Poor_graft = u_transplantation_pg_function$Value,
  HIV = u_HIV$Value,
  HBV = u_CHB_hepB$Value,
  HCV = u_CHC_hepC$Value,
  HepB_Comp_cirr = u_CC_hepB$Value,
  HepC_Comp_cirr = u_CC_hepC$Value,
  HepB_Decomp_cirr = u_DC_hepB$Value,
  HepC_Decomp_cirr = u_DC_hepC$Value,
  HepB_HCC = u_HCC_hepB$Value,
  HepC_HCC = u_HCC_hepC$Value,
  Spon_clear = u_sag_clearance$Value,
  SVR = u_SVR_hepC$Value,
  Liver_trans_1yr = u_liver_transplant_year_1$Value,
  Liver_trans_2yr= u_liver_transplant_year_2$Value,
  Death_waitlist = 0,
  Death_off_waitlist = 0,
  Death_after_graft_failure = 0,
  Death_w_functioning_graft = 0,
  Death_liver = 0) * cycle_length

```

# Vector of state costs under current and proposed practice
```{r echo=FALSE}
waitlist_Cost <- sum((pro_HD * c_in_centre_haemodialysis$Value),
                     (pro_PD * c_peritoneal_dialysis$Value),
                     (pro_HHD * c_home_haemodialysis$Value)
) * cycle_length

off_Waitlist_cost <- sum((pro_HD * c_in_centre_haemodialysis$Value),
                         (pro_PD * c_peritoneal_dialysis$Value),
                         (pro_HHD * c_home_haemodialysis$Value)
) * cycle_length



v_c <-
  c(
    Waitlist = waitlist_Cost,
    DBD_SCD_good = c_kidney_transplant_year_1,
    DBD_SCD_moderate = c_kidney_transplant_year_1,
    DBD_SCD_poor = c_kidney_transplant_year_1,
    DBD_ECD_good = c_kidney_transplant_year_1,
    DBD_ECD_moderate = c_kidney_transplant_year_1,
    DBD_ECD_poor = c_kidney_transplant_year_1,
    DCD_good = c_kidney_transplant_year_1,
    DCD_moderate = c_kidney_transplant_year_1,
    DCD_poor = c_kidney_transplant_year_1,
    gg_DBD_SCD = 0,
    mg_DBD_SCD = 0,
    pg_DBD_SCD = 0,
    gg_DBD_ECD = 0,
    mg_DBD_ECD = 0,
    pg_DBD_ECD = 0,
    gg_DCD = 0,
    mg_DCD = 0,
    pg_DCD = 0,
    Off_waitlist = off_Waitlist_cost,
    Good_graft = c_good_graft_post_transplant$Value * cycle_length,
    Moderate_graft = c_moderate_graft_post_transplant$Value * cycle_length,
    Poor_graft = c_poor_graft_post_transplant$Value * cycle_length,
    HIV = (
      c_remaining_HIV) * cycle_length,
    HBV = c_chronic_hepB$Value * cycle_length,
    HCV = c_chronic_HCV$Value * cycle_length,
    HepB_Comp_cirr = c_compensated_cirrhosis_hepB$Value * cycle_length,
    HepC_Comp_cirr = c_compensated_cirrhosis_hepC$Value * cycle_length,
    HepB_Decomp_cirr = c_decompensated_cirrhosis_hepB$Value * cycle_length,
    HepC_Decomp_cirr = c_decompensated_cirrhosis_hepC$Value * cycle_length,
    HepB_HCC = c_hepatocellular_carcinoma_hepB$Value * cycle_length,
    HepC_HCC = c_hepatocellular_carcinoma_hepC$Value * cycle_length,
    Spon_clear = c_chronic_hepB$Value * cycle_length,
    SVR =  0,
    Liver_trans_1yr = c_liver_transplant_year_1$Value * cycle_length,
    Liver_trans_2yr = c_liver_transplant_year_2$Value * cycle_length,
    Death_waitlist = 0,
    Death_off_waitlist = 0,
    Death_after_graft_failure = 0,
    Death_w_functioning_graft = 0,
    Death_liver = 0 )

c_dbd_scd_good <- 
  (sum(
    c_kidney_transplant_year_1,
    c_follow_up$Value,
    c_diagosis_proposed_policy,
    (c_proph_hepB))* round(per_effect_increased_risk_behaviours * (1 - pro_DBDSCD_mg - pro_DBDSCD_pg - tp_graft_failure), 4))

c_dbd_scd_moderate <- 
  (sum(
    c_kidney_transplant_year_1,
    c_follow_up$Value,
    c_diagosis_proposed_policy,
    (c_proph_hepB))*  round(pro_DBDSCD_mg * per_effect_increased_risk_behaviours, 4))

c_dbd_scd_poor <- 
  (sum(
    c_kidney_transplant_year_1,
    c_follow_up$Value,
    c_diagosis_proposed_policy,
    (c_proph_hepB))*  
  round(pro_DBDSCD_pg * per_effect_increased_risk_behaviours, 4) )


c_treating_hepC <- sum(c_diagnosing_HCV$Value, mean(c(c_treating_mild_moderate_chronic_hepC_gen1_2$Value, c_treating_mild_moderate_chronic_hepC_gen3$Value)))


c_kt_hcv <- sum(
    c_kidney_transplant_year_1,
    c_diagnosing_HCV$Value, c_treating_hepC, c_follow_up$Value)
```

# Create transition rewards 
## Current practice

### Base cost and qalys
```{r}
# Initialize vectors for base and additional costs
v_cost_cp <- numeric(n_cycles + 1)
v_qalys_cp <- numeric(n_cycles + 1)

# Calculate base costs from state occupancies for both practices
for (i in 1:(n_cycles + 1)) {
  v_cost_cp[i] <- sum(m_M_current_practice_sum[i,] * v_c)
  v_qalys_cp[i] <- sum(m_M_current_practice_sum[i,] * v_u)
}
```


### Transtion costs

```{r}
additional_costs_cp <- numeric(n_cycles + 1)

# Calculate additional costs for current practice
for (i in 2:(n_cycles + 1)) {
  additional_costs_cp[i] <- 0  # Reset to 0 for each cycle
  
   # hbv
   for (state in c(
    "DBD SCD good",
    "DBD SCD moderate",
    "DBD SCD poor",
    "DBD ECD good",
    "DBD ECD moderate",
    "DBD ECD poor",
    "DCD good",
    "DCD moderate",
    "DCD poor"
  )) {
    transition_to_hbv <-
      m_M_current_practice[i - 1, state] * m_P_current_practice[state, "HBV"]
    additional_costs_cp[i] <-
      additional_costs_cp[i] + transition_to_hbv * c_diagnosing_hepB$Value
   }
  
   # hiv
   for (state in c(
    "DBD SCD good",
    "DBD SCD moderate",
    "DBD SCD poor",
    "DBD ECD good",
    "DBD ECD moderate",
    "DBD ECD poor",
    "DCD good",
    "DCD moderate",
    "DCD poor"
  )) {
    transition_to_hiv <-
      m_M_current_practice[i - 1, state] * m_P_current_practice[state, "HIV"]
    additional_costs_cp[i] <-
      additional_costs_cp[i] + transition_to_hiv * c_diagnosing_HIV$Value
   }
  
# hcv  
  for (state in c(
    "DBD SCD good",
    "DBD SCD moderate",
    "DBD SCD poor",
    "DBD ECD good",
    "DBD ECD moderate",
    "DBD ECD poor",
    "DCD good",
    "DCD moderate",
    "DCD poor"
  )) {
    transition_to_hcv <-
      m_M_current_practice[i - 1, state] * m_P_current_practice[state, "HCV"]
    additional_costs_cp[i] <-
      additional_costs_cp[i] + transition_to_hcv * c_treating_hepC
  }
  
  # back to waitlist
  
  transition_to_waitlist <-
    m_M_current_practice[i - 1, "Off waitlist"] * m_P_current_practice["Off waitlist", "On waitlist"]
  additional_costs_cp[i] <-
    additional_costs_cp[i] + transition_to_waitlist * c_work_up_transplant_waitlist$Value
  
  # to compensated cirr
  transtion_to_comp_cirr_hbv <- 
    m_M_current_practice[i -1, "HBV"] * m_P_current_practice["HBV", "Hep B Comp cirr"]
  additional_costs_cp[i] <-
    additional_costs_cp[i] + transtion_to_comp_cirr_hbv * c_one_off_transition_to_CC$Value
  
  transtion_to_comp_cirr_hcv <- 
    m_M_current_practice[i -1, "HCV"] * m_P_current_practice["HCV", "Hep C comp cirr"]
  additional_costs_cp[i] <-
    additional_costs_cp[i] + transtion_to_comp_cirr_hcv * c_one_off_transition_to_CC$Value
  
  # to hcc
  transition_to_hcc_hbv <-
    m_M_current_practice[i -1, "HBV"] * m_P_current_practice["HBV", "Hep B HCC"]
  additional_costs_cp[i] <-
    additional_costs_cp[i] + transition_to_hcc_hbv * c_one_off_transition_to_hcc$Value
  

  transition_to_hcc_hbv_comp <-
    m_M_current_practice[i -1, "Hep B Comp cirr"] * m_P_current_practice["Hep B Comp cirr", "Hep B HCC"]
  additional_costs_cp[i] <-
    additional_costs_cp[i] + transition_to_hcc_hbv_comp * c_one_off_transition_to_hcc$Value
  
  transition_to_hcc_hcv_comp <-
    m_M_current_practice[i -1, "Hep C comp cirr"] * m_P_current_practice["Hep C comp cirr", "Hep C HCC"]
  additional_costs_cp[i] <-
    additional_costs_cp[i] + transition_to_hcc_hcv_comp * c_one_off_transition_to_hcc$Value
  
   transition_to_hcc_hbv_decomp <-
    m_M_current_practice[i -1, "Hep B Decomp cirr"] * m_P_current_practice["Hep B Decomp cirr", "Hep B HCC"]
  additional_costs_cp[i] <-
    additional_costs_cp[i] + transition_to_hcc_hbv_decomp * c_one_off_transition_to_hcc$Value
  
  transition_to_hcc_hcv_decomp <-
    m_M_current_practice[i -1, "Hep C Decomp cirr"] * m_P_current_practice["Hep C Decomp cirr", "Hep C HCC"]
  additional_costs_cp[i] <-
    additional_costs_cp[i] + transition_to_hcc_hcv_decomp * c_one_off_transition_to_hcc$Value
  
  # to SVR
   transition_to_SVR <-
    m_M_current_practice[i - 1, "HCV"] * m_P_current_practice["HCV", "SVR"]
  additional_costs_cp[i] <-
    additional_costs_cp[i] + transition_to_SVR * c_SVR_hepC$Value

  
  v_cost_cp[i] <- v_cost_cp[i] + additional_costs_cp[i]
}
```

### Transition qalys 

```{r}
additional_qalys_cp <- numeric(n_cycles + 1)

# Calculate additional QALYs for current practice
for (i in 2:(n_cycles + 1)) {
  additional_qalys_cp[i] <- 0  # Reset to 0 for each cycle
  
  # from waitlist health state
  
  transitions_to_DBD_SCD_good <-
    m_M_current_practice[i - 1, "On waitlist"] * m_P_current_practice["On waitlist", "DBD SCD good"]
  
  transitions_to_DBD_SCD_moderate <-
    m_M_current_practice[i - 1, "On waitlist"] * m_P_current_practice["On waitlist", "DBD SCD moderate"]
  
  transitions_to_DBD_SCD_poor <-
    m_M_current_practice[i - 1, "On waitlist"] * m_P_current_practice["On waitlist", "DBD SCD poor"]
  
  transitions_to_DBD_ECD_good <-
    m_M_current_practice[i - 1, "On waitlist"] * m_P_current_practice["On waitlist", "DBD ECD good"]
  
  transitions_to_DBD_ECD_moderate <-
    m_M_current_practice[i - 1, "On waitlist"] * m_P_current_practice["On waitlist", "DBD ECD moderate"]
  
  transitions_to_DBD_ECD_poor <-
    m_M_current_practice[i - 1, "On waitlist"] * m_P_current_practice["On waitlist", "DBD ECD poor"]
  
  transitions_to_DCD_good <-
    m_M_current_practice[i - 1, "On waitlist"] * m_P_current_practice["On waitlist", "DCD good"]
  
  transitions_to_DCD_moderate <-
    m_M_current_practice[i - 1, "On waitlist"] * m_P_current_practice["On waitlist", "DCD moderate"]
  
  transitions_to_DCD_poor <-
    m_M_current_practice[i - 1, "On waitlist"] * m_P_current_practice["On waitlist", "DCD poor"]
  
  transitions_to_off_waitlist_from_waitlist <-
    m_M_current_practice[i - 1, "On waitlist"] * m_P_current_practice["On waitlist", "Off waitlist"]
  
  # Initialize to zero then accumulate QALYS
  additional_qalys_cp[i] <- additional_qalys_cp[i] +
    transitions_to_DBD_SCD_good * u_transplantation_gg_function$Value  * cycle_length +
    transitions_to_DBD_SCD_moderate * u_transplantation_mg_function$Value  * cycle_length +
    transitions_to_DBD_SCD_poor * u_transplantation_pg_function$Value  * cycle_length +
    
    transitions_to_DBD_ECD_good * u_transplantation_gg_function$Value  * cycle_length +
    transitions_to_DBD_ECD_moderate * u_transplantation_mg_function$Value  * cycle_length +
    transitions_to_DBD_ECD_poor * u_transplantation_pg_function$Value  * cycle_length +
    
    transitions_to_DCD_good * u_transplantation_gg_function$Value  * cycle_length +
    transitions_to_DCD_moderate * u_transplantation_mg_function$Value  * cycle_length +
    transitions_to_DCD_poor * u_transplantation_pg_function$Value  * cycle_length +
    
    transitions_to_off_waitlist_from_waitlist * u_dialysis_temp_off_waitlist$Value * cycle_length
  
  # from good, moderate, poor DBDSCD, DBD ECD, DCD donors
  
  ##
  transition_to_gg_functioning_dbdscd <-
    m_M_current_practice[i - 1, "DBD SCD good"] * m_P_current_practice["DBD SCD good", "Good graft DBD SCD"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_gg_functioning_dbdscd * u_transplantation_gg_function$Value * cycle_length
  
  ##
  transition_to_mg_functioning_dbdscd <-
    m_M_current_practice[i - 1, "DBD SCD moderate"] * m_P_current_practice["DBD SCD moderate", "Moderate graft DBD SCD"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_mg_functioning_dbdscd * u_transplantation_mg_function$Value * cycle_length
  
  ##
  transition_to_pg_functioning_dbdscd <-
    m_M_current_practice[i - 1, "DBD SCD poor"] * m_P_current_practice["DBD SCD poor", "Poor graft DBD SCD"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_pg_functioning_dbdscd * u_transplantation_pg_function$Value * cycle_length
  
  ##
  transition_to_gg_functioning_dbdecd <-
    m_M_current_practice[i - 1, "DBD ECD good"] * m_P_current_practice["DBD ECD good", "Good graft DBD ECD"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_gg_functioning_dbdecd * u_transplantation_gg_function$Value * cycle_length
  
  ##
  transition_to_mg_functioning_dbdecd <-
    m_M_current_practice[i - 1, "DBD ECD moderate"] * m_P_current_practice["DBD ECD moderate", "Moderate graft DBD ECD"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_mg_functioning_dbdecd * u_transplantation_mg_function$Value * cycle_length
  
  ##
  transition_to_pg_functioning_dbdecd <-
    m_M_current_practice[i - 1, "DBD ECD poor"] * m_P_current_practice["DBD ECD poor", "Poor graft DBD ECD"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_pg_functioning_dbdecd * u_transplantation_pg_function$Value * cycle_length
  
  ##
  transition_to_gg_functioning_dcd <-
    m_M_current_practice[i - 1, "DCD good"] * m_P_current_practice["DCD good", "Good graft DCD"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_gg_functioning_dcd * u_transplantation_gg_function$Value * cycle_length
  
  ##
  transition_to_mg_functioning_dcd <-
    m_M_current_practice[i - 1, "DCD moderate"] * m_P_current_practice["DCD moderate", "Moderate graft DCD"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_mg_functioning_dcd * u_transplantation_mg_function$Value * cycle_length
  
  ##
  transition_to_pg_functioning_dcd <-
    m_M_current_practice[i - 1, "DCD poor"] * m_P_current_practice["DCD poor", "Poor graft DCD"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_pg_functioning_dcd * u_transplantation_pg_function$Value * cycle_length
  
  ##
  for (state in c(
    "DBD SCD good",
    "DBD SCD moderate",
    "DBD SCD poor",
    "DBD ECD good",
    "DBD ECD moderate",
    "DBD ECD poor",
    "DCD good",
    "DCD moderate",
    "DCD poor"
  )) {
    transition_to_hiv <-
      m_M_current_practice[i - 1, state] * m_P_current_practice[state, "HIV"]
    additional_qalys_cp[i] <-
      additional_qalys_cp[i] + transition_to_hiv * u_HIV$Value * cycle_length
  }
  
  # Add QALYs for HBV transitions from various states
  for (state in c(
    "DBD SCD good",
    "DBD SCD moderate",
    "DBD SCD poor",
    "DBD ECD good",
    "DBD ECD moderate",
    "DBD ECD poor",
    "DCD good",
    "DCD moderate",
    "DCD poor"
  )) {
    transition_to_hbv <-
      m_M_current_practice[i - 1, state] * m_P_current_practice[state, "HBV"]
    additional_qalys_cp[i] <-
      additional_qalys_cp[i] + transition_to_hbv * u_CHB_hepB$Value * cycle_length
  }
  
  
  # Add QALYs for HCV transitions from various states
  for (state in c(
    "DBD SCD good",
    "DBD SCD moderate",
    "DBD SCD poor",
    "DBD ECD good",
    "DBD ECD moderate",
    "DBD ECD poor",
    "DCD good",
    "DCD moderate",
    "DCD poor"
  )) {
    transition_to_hcv <-
      m_M_current_practice[i - 1, state] * m_P_current_practice[state, "HCV"]
    additional_qalys_cp[i] <-
      additional_qalys_cp[i] + transition_to_hcv * u_CHC_hepC$Value * cycle_length
  }
  
  # transitions from good graft functioning
  
  transitions_to_mg_dbdscd <-
    m_M_current_practice[i - 1, "Good graft DBD SCD"] * m_P_current_practice["Good graft DBD SCD", "Moderate graft DBD SCD"]
  
  transitions_to_pg_dbdscd <-
    m_M_current_practice[i - 1, "Good graft DBD SCD"] * m_P_current_practice["Good graft DBD SCD", "Poor graft DBD SCD"]
  
  transitions_to_mg_dbdecd <-
    m_M_current_practice[i - 1, "Good graft DBD ECD"] * m_P_current_practice["Good graft DBD ECD", "Moderate graft DBD ECD"]
  
  transitions_to_pg_dbdecd <-
    m_M_current_practice[i - 1, "Good graft DBD ECD"] * m_P_current_practice["Good graft DBD ECD", "Poor graft DBD ECD"]
  
  transitions_to_mg_dcd <-
    m_M_current_practice[i - 1, "Good graft DCD"] * m_P_current_practice["Good graft DCD", "Moderate graft DCD"]
  
  transitions_to_pg_dcd <-
    m_M_current_practice[i - 1, "Good graft DCD"] * m_P_current_practice["Good graft DCD", "Poor graft DCD"]
  
  additional_qalys_cp[i] <- additional_qalys_cp[i] +
    transitions_to_mg_dbdscd * u_transplantation_mg_function$Value * cycle_length +
    transitions_to_pg_dbdscd * u_transplantation_pg_function$Value * cycle_length +
    transitions_to_mg_dbdecd * u_transplantation_mg_function$Value * cycle_length +
    transitions_to_pg_dbdecd * u_transplantation_pg_function$Value * cycle_length +
    transitions_to_mg_dcd * u_transplantation_mg_function$Value * cycle_length +
    transitions_to_pg_dcd * u_transplantation_pg_function$Value * cycle_length
  
  # transitions from moderate graft functioning
  
  transitions_to_pg_dbdscd_mg <-
    m_M_current_practice[i - 1, "Moderate graft DBD SCD"] * m_P_current_practice["Moderate graft DBD SCD", "Poor graft DBD SCD"]
  
  
  transitions_to_pg_dbdecd_mg <-
    m_M_current_practice[i - 1, "Moderate graft DBD ECD"] * m_P_current_practice["Moderate graft DBD ECD", "Poor graft DBD ECD"]
  
  
  transitions_to_pg_dcd_mg <-
    m_M_current_practice[i - 1, "Moderate graft DCD"] * m_P_current_practice["Moderate graft DCD", "Poor graft DCD"]
  
  additional_qalys_cp[i] <- additional_qalys_cp[i] +
    transitions_to_pg_dbdscd_mg * u_transplantation_pg_function$Value * cycle_length +
    transitions_to_pg_dbdecd_mg * u_transplantation_pg_function$Value * cycle_length +
    transitions_to_pg_dcd_mg * u_transplantation_pg_function$Value * cycle_length
  
  
  # transitions from poor graft functioning
  transitions_to_off_waitlist_dbdscd_pg <-
    m_M_current_practice[i - 1, "Poor graft DBD SCD"] * m_P_current_practice["Poor graft DBD SCD", "Off waitlist"]
  
  
  transitions_to_off_waitlist_dbdecd_pg <-
    m_M_current_practice[i - 1, "Poor graft DBD ECD"] * m_P_current_practice["Poor graft DBD ECD", "Off waitlist"]
  
  
  transitions_to_off_waitlist_dcd_pg <-
    m_M_current_practice[i - 1, "Poor graft DCD"] * m_P_current_practice["Poor graft DCD", "Off waitlist"]
  
  additional_qalys_cp[i] <- additional_qalys_cp[i] +
    transitions_to_off_waitlist_dbdscd_pg * u_dialysis_temp_off_waitlist$Value * cycle_length +
    transitions_to_off_waitlist_dbdecd_pg * u_dialysis_temp_off_waitlist$Value * cycle_length +
    transitions_to_off_waitlist_dcd_pg * u_dialysis_temp_off_waitlist$Value * cycle_length
  
  # transitions from temporary off waitlist
  transitions_to_waitlist <-
    m_M_current_practice[i - 1, "Off waitlist"] * m_P_current_practice["Off waitlist", "On waitlist"]
  
  additional_qalys_cp[i] <- additional_qalys_cp[i] +
    transitions_to_waitlist * u_on_waitlist_dialysis$Value * cycle_length
  
  
  # transitions from chb to comp cirr
  transitions_to_comp_cirr_hepB <-
    m_M_current_practice[i - 1, "HBV"] * m_P_current_practice["HBV", "Hep B Comp cirr"]
  
  additional_qalys_cp[i] <- additional_qalys_cp[i] +
    transitions_to_comp_cirr_hepB * u_CC_hepB$Value * cycle_length
  
  # transitions from chb to hepat carci
  transitions_to_hcc_hepB <-
    m_M_current_practice[i - 1, "HBV"] * m_P_current_practice["HBV", "Hep B HCC"]
  
  additional_qalys_cp[i] <- additional_qalys_cp[i] +
    transitions_to_hcc_hepB * u_HCC_hepB$Value * cycle_length
  
  # transitions from chb to spon clearance
  transitions_to_spon_clearance_hepB <-
    m_M_current_practice[i - 1, "HBV"] * m_P_current_practice["HBV", "Spon clearance"]
  
  additional_qalys_cp[i] <- additional_qalys_cp[i] +
    transitions_to_spon_clearance_hepB * u_sag_clearance$Value * cycle_length
  
  
  # transitions to svr from hcv
  transition_to_SVR <-
    m_M_current_practice[i - 1, "HCV"] * m_P_current_practice["HCV", "SVR"]
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_SVR * u_SVR_hepC$Value  * cycle_length
  
  
  # transition to comp cirr from hcv
  transitions_to_comp_cirr_hepc <-
    m_M_current_practice[i - 1, "HCV"] * m_P_current_practice["HCV", "Hep C comp cirr"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transitions_to_comp_cirr_hepc * u_CC_hepC$Value  * cycle_length
  
  
  # transtiion to decomp cirr from comp cirr
  transitions_to_decomp_cirr_compcirr_hbv <-
    m_M_current_practice[i - 1, "Hep B Comp cirr"] * m_P_current_practice["Hep B Comp cirr", "Hep B Decomp cirr"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transitions_to_decomp_cirr_compcirr_hbv * u_DC_hepB$Value  * cycle_length
  
  transitions_to_decomp_cirr_compcirr_hcv <-
    m_M_current_practice[i - 1, "Hep C comp cirr"] * m_P_current_practice["Hep C comp cirr", "Hep C Decomp cirr"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transitions_to_decomp_cirr_compcirr_hcv * u_DC_hepC$Value  * cycle_length
  
  
  # transition to hcc from comp cirr
  transitions_to_hcc_compcirr_hbv <-
    m_M_current_practice[i - 1, "Hep B Comp cirr"] * m_P_current_practice["Hep B Comp cirr", "Hep B HCC"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transitions_to_hcc_compcirr_hbv * u_HCC_hepB$Value  * cycle_length
  
  
  transitions_to_hcc_compcirr_hcv <-
    m_M_current_practice[i - 1, "Hep C comp cirr"] * m_P_current_practice["Hep C comp cirr", "Hep C HCC"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transitions_to_hcc_compcirr_hcv * u_HCC_hepC$Value  * cycle_length
  
  
  # transition to hcc from decomp cirr
  transitions_to_hcc_decompcirr_hbv <-
    m_M_current_practice[i - 1, "Hep B Decomp cirr"] * m_P_current_practice["Hep B Decomp cirr", "Hep B HCC"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transitions_to_hcc_decompcirr_hbv * u_HCC_hepB$Value  * cycle_length
  
  transitions_to_hcc_decompcirr_hcv <-
    m_M_current_practice[i - 1, "Hep C Decomp cirr"] * m_P_current_practice["Hep C Decomp cirr", "Hep C HCC"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transitions_to_hcc_decompcirr_hcv * u_HCC_hepC$Value  * cycle_length
  
  
  # transition to lt from decomp cirr
  transition_to_lt_decomp_cirr_hbv <-
    m_M_current_practice[i - 1, "Hep B Decomp cirr"] * m_P_current_practice["Hep B Decomp cirr", "Liver transplant 3"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_lt_decomp_cirr_hbv * u_liver_transplant_year_1$Value  * cycle_length
  
  transition_to_lt_decomp_cirr_hcv <-
    m_M_current_practice[i - 1, "Hep C Decomp cirr"] * m_P_current_practice["Hep C Decomp cirr", "Liver transplant 3"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_lt_decomp_cirr_hcv * u_liver_transplant_year_1$Value  * cycle_length
  
  
  # transition to lt from hcc
  transition_to_lt_hcc_hbv <-
    m_M_current_practice[i - 1, "Hep B HCC"] * m_P_current_practice["Hep B HCC", "Liver transplant 3"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_lt_hcc_hbv * u_liver_transplant_year_1$Value  * cycle_length
  
  transition_to_lt_hcc_hcv <-
    m_M_current_practice[i - 1, "Hep C HCC"] * m_P_current_practice["Hep C HCC", "Liver transplant 3"]
  
  additional_qalys_cp[i] <-
    additional_qalys_cp[i] + transition_to_lt_hcc_hcv * u_liver_transplant_year_1$Value  * cycle_length
  
  
  v_qalys_cp[i] <- v_qalys_cp[i] + additional_qalys_cp[i]
}
```

## Proposed practice

### Base cost and qalys
```{r}
# Initialize vectors for base and additional costs
v_cost_pp <- numeric(n_cycles + 1)
v_qalys_pp <- numeric(n_cycles + 1)

# Calculate base costs from state occupancies for both practices
for (i in 1:(n_cycles + 1)) {
  v_cost_pp[i] <- sum(m_M_proposed_practice_sum[i,] * v_c)
  v_qalys_pp[i] <- sum(m_M_proposed_practice_sum[i,] * v_u)
}
```


### Transition costs

```{r}
additional_costs_pp <- numeric(n_cycles + 1)

# Calculate additional costs for proposed practice
for (i in 2:(n_cycles + 1)) {
  additional_costs_pp[i] <- 0  # Reset to 0 for each cycle
  
  transitions_to_DBD_SCD_good <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "DBD SCD good"]
  
  transitions_to_DBD_SCD_moderate <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "DBD SCD moderate"]
  
  transitions_to_DBD_SCD_poor <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "DBD SCD poor"]
  
  transitions_to_hcv_from_waitlist <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "HCV"]
  
  # Initialize to zero then accumulate costs
  additional_costs_pp[i] <-
    transitions_to_DBD_SCD_good * c_dbd_scd_good +
    transitions_to_DBD_SCD_moderate * c_dbd_scd_moderate +
    transitions_to_DBD_SCD_poor * c_dbd_scd_poor +
    transitions_to_hcv_from_waitlist * c_kt_hcv
  
   # hbv
   for (state in c(
    "DBD SCD good",
    "DBD SCD moderate",
    "DBD SCD poor",
    "DBD ECD good",
    "DBD ECD moderate",
    "DBD ECD poor",
    "DCD good",
    "DCD moderate",
    "DCD poor"
  )) {
    transition_to_hbv <-
      m_M_proposed_practice[i - 1, state] * m_P_proposed_practice[state, "HBV"]
    additional_costs_pp[i] <-
      additional_costs_pp[i] + transition_to_hbv * c_diagnosing_hepB$Value
   }
  
   # hiv
   for (state in c(
    "DBD SCD good",
    "DBD SCD moderate",
    "DBD SCD poor",
    "DBD ECD good",
    "DBD ECD moderate",
    "DBD ECD poor",
    "DCD good",
    "DCD moderate",
    "DCD poor"
  )) {
    transition_to_hiv <-
      m_M_proposed_practice[i - 1, state] * m_P_proposed_practice[state, "HIV"]
    additional_costs_pp[i] <-
      additional_costs_pp[i] + transition_to_hiv * c_diagnosing_HIV$Value
   }
  
# hcv  
  for (state in c(
    "DBD SCD good",
    "DBD SCD moderate",
    "DBD SCD poor",
    "DBD ECD good",
    "DBD ECD moderate",
    "DBD ECD poor",
    "DCD good",
    "DCD moderate",
    "DCD poor"
  )) {
    transition_to_hcv <-
      m_M_proposed_practice[i - 1, state] * m_P_proposed_practice[state, "HCV"]
    additional_costs_pp[i] <-
      additional_costs_pp[i] + transition_to_hcv * c_treating_hepC
  }
  
  # back to waitlist
  
  transition_to_waitlist <-
    m_M_proposed_practice[i - 1, "Off waitlist"] * m_P_proposed_practice["Off waitlist", "On waitlist"]
  additional_costs_pp[i] <-
    additional_costs_pp[i] + transition_to_waitlist * c_work_up_transplant_waitlist$Value
  
  # to compensated cirr
  transtion_to_comp_cirr_hbv <- 
    m_M_proposed_practice[i -1, "HBV"] * m_P_proposed_practice["HBV", "Hep B Comp cirr"]
  additional_costs_pp[i] <-
    additional_costs_pp[i] + transtion_to_comp_cirr_hbv * c_one_off_transition_to_CC$Value
  
  transtion_to_comp_cirr_hcv <- 
    m_M_proposed_practice[i -1, "HCV"] * m_P_proposed_practice["HCV", "Hep C comp cirr"]
  additional_costs_pp[i] <-
    additional_costs_pp[i] + transtion_to_comp_cirr_hcv * c_one_off_transition_to_CC$Value
  
  # to hcc
  transition_to_hcc_hbv <-
    m_M_proposed_practice[i -1, "HBV"] * m_P_proposed_practice["HBV", "Hep B HCC"]
  additional_costs_pp[i] <-
    additional_costs_pp[i] + transition_to_hcc_hbv * c_one_off_transition_to_hcc$Value
  

  transition_to_hcc_hbv_comp <-
    m_M_proposed_practice[i -1, "Hep B Comp cirr"] * m_P_proposed_practice["Hep B Comp cirr", "Hep B HCC"]
  additional_costs_pp[i] <-
    additional_costs_pp[i] + transition_to_hcc_hbv_comp * c_one_off_transition_to_hcc$Value
  
  transition_to_hcc_hcv_comp <-
    m_M_proposed_practice[i -1, "Hep C comp cirr"] * m_P_proposed_practice["Hep C comp cirr", "Hep C HCC"]
  additional_costs_pp[i] <-
    additional_costs_pp[i] + transition_to_hcc_hcv_comp * c_one_off_transition_to_hcc$Value
  
   transition_to_hcc_hbv_decomp <-
    m_M_proposed_practice[i -1, "Hep B Decomp cirr"] * m_P_proposed_practice["Hep B Decomp cirr", "Hep B HCC"]
  additional_costs_pp[i] <-
    additional_costs_pp[i] + transition_to_hcc_hbv_decomp * c_one_off_transition_to_hcc$Value
  
  transition_to_hcc_hcv_decomp <-
    m_M_proposed_practice[i -1, "Hep C Decomp cirr"] * m_P_proposed_practice["Hep C Decomp cirr", "Hep C HCC"]
  additional_costs_pp[i] <-
    additional_costs_pp[i] + transition_to_hcc_hcv_decomp * c_one_off_transition_to_hcc$Value
  
  # to SVR
   transition_to_SVR <-
    m_M_proposed_practice[i - 1, "HCV"] * m_P_proposed_practice["HCV", "SVR"]
  additional_costs_pp[i] <-
    additional_costs_pp[i] + transition_to_SVR * c_SVR_hepC$Value
  
  v_cost_pp[i] <- v_cost_pp[i] + additional_costs_pp[i]
}
```

### Transition qalys 

```{r}
additional_qalys_pp <- numeric(n_cycles + 1)

# Calculate additional QALYs for proposed practice
for (i in 2:(n_cycles + 1)) {
  additional_qalys_pp[i] <- 0  # Reset to 0 for each cycle
  
  # from waitlist health state
  
  transitions_to_DBD_SCD_good <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "DBD SCD good"]
  
  transitions_to_DBD_SCD_moderate <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "DBD SCD moderate"]
  
  transitions_to_DBD_SCD_poor <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "DBD SCD poor"]
  
  transitions_to_DBD_ECD_good <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "DBD ECD good"]
  
  transitions_to_DBD_ECD_moderate <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "DBD ECD moderate"]
  
  transitions_to_DBD_ECD_poor <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "DBD ECD poor"]
  
  transitions_to_DCD_good <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "DCD good"]
  
  transitions_to_DCD_moderate <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "DCD moderate"]
  
  transitions_to_DCD_poor <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "DCD poor"]
  
  transitions_to_hcv_from_waitlist <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "HCV"]
  
  transitions_to_off_waitlist_from_waitlist <-
    m_M_proposed_practice[i - 1, "On waitlist"] * m_P_proposed_practice["On waitlist", "Off waitlist"]
  
  # Initialize to zero then accumulate QALYS
  additional_qalys_pp[i] <- additional_qalys_pp[i] +
    transitions_to_DBD_SCD_good * u_transplantation_gg_function$Value  * cycle_length +
    transitions_to_DBD_SCD_moderate * u_transplantation_mg_function$Value  * cycle_length +
    transitions_to_DBD_SCD_poor * u_transplantation_pg_function$Value  * cycle_length +
    
    transitions_to_DBD_ECD_good * u_transplantation_gg_function$Value  * cycle_length +
    transitions_to_DBD_ECD_moderate * u_transplantation_mg_function$Value  * cycle_length +
    transitions_to_DBD_ECD_poor * u_transplantation_pg_function$Value  * cycle_length +
    
    transitions_to_DCD_good * u_transplantation_gg_function$Value  * cycle_length +
    transitions_to_DCD_moderate * u_transplantation_mg_function$Value  * cycle_length +
    transitions_to_DCD_poor * u_transplantation_pg_function$Value  * cycle_length +
    
    transitions_to_hcv_from_waitlist * u_CHC_hepC$Value  * cycle_length +
    
    transitions_to_off_waitlist_from_waitlist * u_dialysis_temp_off_waitlist$Value * cycle_length
  
  # from good, moderate, poor DBDSCD, DBD ECD, DCD donors
  
  ##
  transition_to_gg_functioning_dbdscd <-
    m_M_proposed_practice[i - 1, "DBD SCD good"] * m_P_proposed_practice["DBD SCD good", "Good graft DBD SCD"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_gg_functioning_dbdscd * u_transplantation_gg_function$Value * cycle_length
  
  ##
  transition_to_mg_functioning_dbdscd <-
    m_M_proposed_practice[i - 1, "DBD SCD moderate"] * m_P_proposed_practice["DBD SCD moderate", "Moderate graft DBD SCD"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_mg_functioning_dbdscd * u_transplantation_mg_function$Value * cycle_length
  
  ##
  transition_to_pg_functioning_dbdscd <-
    m_M_proposed_practice[i - 1, "DBD SCD poor"] * m_P_proposed_practice["DBD SCD poor", "Poor graft DBD SCD"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_pg_functioning_dbdscd * u_transplantation_pg_function$Value * cycle_length
  
  ##
  transition_to_gg_functioning_dbdecd <-
    m_M_proposed_practice[i - 1, "DBD ECD good"] * m_P_proposed_practice["DBD ECD good", "Good graft DBD ECD"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_gg_functioning_dbdecd * u_transplantation_gg_function$Value * cycle_length
  
  ##
  transition_to_mg_functioning_dbdecd <-
    m_M_proposed_practice[i - 1, "DBD ECD moderate"] * m_P_proposed_practice["DBD ECD moderate", "Moderate graft DBD ECD"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_mg_functioning_dbdecd * u_transplantation_mg_function$Value * cycle_length
  
  ##
  transition_to_pg_functioning_dbdecd <-
    m_M_proposed_practice[i - 1, "DBD ECD poor"] * m_P_proposed_practice["DBD ECD poor", "Poor graft DBD ECD"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_pg_functioning_dbdecd * u_transplantation_pg_function$Value * cycle_length
  
  ##
  transition_to_gg_functioning_dcd <-
    m_M_proposed_practice[i - 1, "DCD good"] * m_P_proposed_practice["DCD good", "Good graft DCD"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_gg_functioning_dcd * u_transplantation_gg_function$Value * cycle_length
  
  ##
  transition_to_mg_functioning_dcd <-
    m_M_proposed_practice[i - 1, "DCD moderate"] * m_P_proposed_practice["DCD moderate", "Moderate graft DCD"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_mg_functioning_dcd * u_transplantation_mg_function$Value * cycle_length
  
  ##
  transition_to_pg_functioning_dcd <-
    m_M_proposed_practice[i - 1, "DCD poor"] * m_P_proposed_practice["DCD poor", "Poor graft DCD"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_pg_functioning_dcd * u_transplantation_pg_function$Value * cycle_length
  
  ##
  for (state in c(
    "DBD SCD good",
    "DBD SCD moderate",
    "DBD SCD poor",
    "DBD ECD good",
    "DBD ECD moderate",
    "DBD ECD poor",
    "DCD good",
    "DCD moderate",
    "DCD poor"
  )) {
    transition_to_hiv <-
      m_M_proposed_practice[i - 1, state] * m_P_proposed_practice[state, "HIV"]
    additional_qalys_pp[i] <-
      additional_qalys_pp[i] + transition_to_hiv * u_HIV$Value * cycle_length
  }
  
  # Add QALYs for HBV transitions from various states
  for (state in c(
    "DBD SCD good",
    "DBD SCD moderate",
    "DBD SCD poor",
    "DBD ECD good",
    "DBD ECD moderate",
    "DBD ECD poor",
    "DCD good",
    "DCD moderate",
    "DCD poor"
  )) {
    transition_to_hbv <-
      m_M_proposed_practice[i - 1, state] * m_P_proposed_practice[state, "HBV"]
    additional_qalys_pp[i] <-
      additional_qalys_pp[i] + transition_to_hbv * u_CHB_hepB$Value * cycle_length
  }
  
  
  # Add QALYs for HCV transitions from various states
  for (state in c(
    "DBD SCD good",
    "DBD SCD moderate",
    "DBD SCD poor",
    "DBD ECD good",
    "DBD ECD moderate",
    "DBD ECD poor",
    "DCD good",
    "DCD moderate",
    "DCD poor"
  )) {
    transition_to_hcv <-
      m_M_proposed_practice[i - 1, state] * m_P_proposed_practice[state, "HCV"]
    additional_qalys_pp[i] <-
      additional_qalys_pp[i] + transition_to_hcv * u_CHC_hepC$Value * cycle_length
  }
  
  # transitions from good graft functioning
  
  transitions_to_mg_dbdscd <-
    m_M_proposed_practice[i - 1, "Good graft DBD SCD"] * m_P_proposed_practice["Good graft DBD SCD", "Moderate graft DBD SCD"]
  
  transitions_to_pg_dbdscd <-
    m_M_proposed_practice[i - 1, "Good graft DBD SCD"] * m_P_proposed_practice["Good graft DBD SCD", "Poor graft DBD SCD"]
  
  transitions_to_mg_dbdecd <-
    m_M_proposed_practice[i - 1, "Good graft DBD ECD"] * m_P_proposed_practice["Good graft DBD ECD", "Moderate graft DBD ECD"]
  
  transitions_to_pg_dbdecd <-
    m_M_proposed_practice[i - 1, "Good graft DBD ECD"] * m_P_proposed_practice["Good graft DBD ECD", "Poor graft DBD ECD"]
  
  transitions_to_mg_dcd <-
    m_M_proposed_practice[i - 1, "Good graft DCD"] * m_P_proposed_practice["Good graft DCD", "Moderate graft DCD"]
  
  transitions_to_pg_dcd <-
    m_M_proposed_practice[i - 1, "Good graft DCD"] * m_P_proposed_practice["Good graft DCD", "Poor graft DCD"]
  
  additional_qalys_pp[i] <- additional_qalys_pp[i] +
    transitions_to_mg_dbdscd * u_transplantation_mg_function$Value * cycle_length +
    transitions_to_pg_dbdscd * u_transplantation_pg_function$Value * cycle_length +
    transitions_to_mg_dbdecd * u_transplantation_mg_function$Value * cycle_length +
    transitions_to_pg_dbdecd * u_transplantation_pg_function$Value * cycle_length +
    transitions_to_mg_dcd * u_transplantation_mg_function$Value * cycle_length +
    transitions_to_pg_dcd * u_transplantation_pg_function$Value * cycle_length
  
  # transitions from moderate graft functioning
  
  transitions_to_pg_dbdscd_mg <-
    m_M_proposed_practice[i - 1, "Moderate graft DBD SCD"] * m_P_proposed_practice["Moderate graft DBD SCD", "Poor graft DBD SCD"]
  
  
  transitions_to_pg_dbdecd_mg <-
    m_M_proposed_practice[i - 1, "Moderate graft DBD ECD"] * m_P_proposed_practice["Moderate graft DBD ECD", "Poor graft DBD ECD"]
  
  
  transitions_to_pg_dcd_mg <-
    m_M_proposed_practice[i - 1, "Moderate graft DCD"] * m_P_proposed_practice["Moderate graft DCD", "Poor graft DCD"]
  
  additional_qalys_pp[i] <- additional_qalys_pp[i] +
    transitions_to_pg_dbdscd_mg * u_transplantation_pg_function$Value * cycle_length +
    transitions_to_pg_dbdecd_mg * u_transplantation_pg_function$Value * cycle_length +
    transitions_to_pg_dcd_mg * u_transplantation_pg_function$Value * cycle_length
  
  
  # transitions from poor graft functioning
  transitions_to_off_waitlist_dbdscd_pg <-
    m_M_proposed_practice[i - 1, "Poor graft DBD SCD"] * m_P_proposed_practice["Poor graft DBD SCD", "Off waitlist"]
  
  
  transitions_to_off_waitlist_dbdecd_pg <-
    m_M_proposed_practice[i - 1, "Poor graft DBD ECD"] * m_P_proposed_practice["Poor graft DBD ECD", "Off waitlist"]
  
  
  transitions_to_off_waitlist_dcd_pg <-
    m_M_proposed_practice[i - 1, "Poor graft DCD"] * m_P_proposed_practice["Poor graft DCD", "Off waitlist"]
  
  additional_qalys_pp[i] <- additional_qalys_pp[i] +
    transitions_to_off_waitlist_dbdscd_pg * u_dialysis_temp_off_waitlist$Value * cycle_length +
    transitions_to_off_waitlist_dbdecd_pg * u_dialysis_temp_off_waitlist$Value * cycle_length +
    transitions_to_off_waitlist_dcd_pg * u_dialysis_temp_off_waitlist$Value * cycle_length
  
  # transitions from temporary off waitlist
  transitions_to_waitlist <-
    m_M_proposed_practice[i - 1, "Off waitlist"] * m_P_proposed_practice["Off waitlist", "On waitlist"]
  
  additional_qalys_pp[i] <- additional_qalys_pp[i] +
    transitions_to_waitlist * u_on_waitlist_dialysis$Value * cycle_length
  
  
  # transitions from chb to comp cirr
  transitions_to_comp_cirr_hepB <-
    m_M_proposed_practice[i - 1, "HBV"] * m_P_proposed_practice["HBV", "Hep B Comp cirr"]
  
  additional_qalys_pp[i] <- additional_qalys_pp[i] +
    transitions_to_comp_cirr_hepB * u_CC_hepB$Value * cycle_length
  
  # transitions from chb to hepat carci
  transitions_to_hcc_hepB <-
    m_M_proposed_practice[i - 1, "HBV"] * m_P_proposed_practice["HBV", "Hep B HCC"]
  
  additional_qalys_pp[i] <- additional_qalys_pp[i] +
    transitions_to_hcc_hepB * u_HCC_hepB$Value * cycle_length
  
  # transitions from chb to spon clearance
  transitions_to_spon_clearance_hepB <-
    m_M_proposed_practice[i - 1, "HBV"] * m_P_proposed_practice["HBV", "Spon clearance"]
  
  additional_qalys_pp[i] <- additional_qalys_pp[i] +
    transitions_to_spon_clearance_hepB * u_sag_clearance$Value * cycle_length
  
  
  # transitions to svr from hcv
  transition_to_SVR <-
    m_M_proposed_practice[i - 1, "HCV"] * m_P_proposed_practice["HCV", "SVR"]
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_SVR * u_SVR_hepC$Value  * cycle_length
  
  
  # transition to comp cirr from hcv
  transitions_to_comp_cirr_hepc <-
    m_M_proposed_practice[i - 1, "HCV"] * m_P_proposed_practice["HCV", "Hep C comp cirr"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transitions_to_comp_cirr_hepc * u_CC_hepC$Value  * cycle_length
  
  
  # transtiion to decomp cirr from comp cirr
  transitions_to_decomp_cirr_compcirr_hbv <-
    m_M_proposed_practice[i - 1, "Hep B Comp cirr"] * m_P_proposed_practice["Hep B Comp cirr", "Hep B Decomp cirr"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transitions_to_decomp_cirr_compcirr_hbv * u_DC_hepB$Value  * cycle_length
  
  transitions_to_decomp_cirr_compcirr_hcv <-
    m_M_proposed_practice[i - 1, "Hep C comp cirr"] * m_P_proposed_practice["Hep C comp cirr", "Hep C Decomp cirr"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transitions_to_decomp_cirr_compcirr_hcv * u_DC_hepC$Value  * cycle_length
  
  
  # transition to hcc from comp cirr
  transitions_to_hcc_compcirr_hbv <-
    m_M_proposed_practice[i - 1, "Hep B Comp cirr"] * m_P_proposed_practice["Hep B Comp cirr", "Hep B HCC"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transitions_to_hcc_compcirr_hbv * u_HCC_hepB$Value  * cycle_length
  
  
  transitions_to_hcc_compcirr_hcv <-
    m_M_proposed_practice[i - 1, "Hep C comp cirr"] * m_P_proposed_practice["Hep C comp cirr", "Hep C HCC"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transitions_to_hcc_compcirr_hcv * u_HCC_hepC$Value  * cycle_length
  
  
  # transition to hcc from decomp cirr
  transitions_to_hcc_decompcirr_hbv <-
    m_M_proposed_practice[i - 1, "Hep B Decomp cirr"] * m_P_proposed_practice["Hep B Decomp cirr", "Hep B HCC"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transitions_to_hcc_decompcirr_hbv * u_HCC_hepB$Value  * cycle_length
  
  transitions_to_hcc_decompcirr_hcv <-
    m_M_proposed_practice[i - 1, "Hep C Decomp cirr"] * m_P_proposed_practice["Hep C Decomp cirr", "Hep C HCC"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transitions_to_hcc_decompcirr_hcv * u_HCC_hepC$Value  * cycle_length
  
  
  # transition to lt from decomp cirr
  transition_to_lt_decomp_cirr_hbv <-
    m_M_proposed_practice[i - 1, "Hep B Decomp cirr"] * m_P_proposed_practice["Hep B Decomp cirr", "Liver transplant 3"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_lt_decomp_cirr_hbv * u_liver_transplant_year_1$Value  * cycle_length
  
  transition_to_lt_decomp_cirr_hcv <-
    m_M_proposed_practice[i - 1, "Hep C Decomp cirr"] * m_P_proposed_practice["Hep C Decomp cirr", "Liver transplant 3"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_lt_decomp_cirr_hcv * u_liver_transplant_year_1$Value  * cycle_length
  
  
  # transition to lt from hcc
  transition_to_lt_hcc_hbv <-
    m_M_proposed_practice[i - 1, "Hep B HCC"] * m_P_proposed_practice["Hep B HCC", "Liver transplant 3"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_lt_hcc_hbv * u_liver_transplant_year_1$Value  * cycle_length
  
  transition_to_lt_hcc_hcv <-
    m_M_proposed_practice[i - 1, "Hep C HCC"] * m_P_proposed_practice["Hep C HCC", "Liver transplant 3"]
  
  additional_qalys_pp[i] <-
    additional_qalys_pp[i] + transition_to_lt_hcc_hcv * u_liver_transplant_year_1$Value  * cycle_length
  
  
  v_qalys_pp[i] <- v_qalys_pp[i] + additional_qalys_pp[i]
}
```

# Results
```{r}
# within cycle correction  --------
# first, we define two functions to identify if a number is even or odd
is_even <- function(x) x %% 2 == 0
is_odd <- function(x) x %% 2 != 0

# Vector with cycles
v_cycles <- seq(1, n_cycles + 1)

# Generate 2/3 and 4/3 multipliers for even and odd entries, respectively
v_wcc <- is_even(v_cycles)*(2/3) + is_odd(v_cycles)*(4/3)

# Substitute 1/3 in first and last entries
v_wcc[1] <- v_wcc[n_cycles + 1] <- 1/3

# Discount weight for effects
d_e <- 0.05
d_c <- 0.05

v_dwe <- 1 / ((1 + (d_e * cycle_length)) ^ (0:n_cycles))

v_dwc <- 1 / ((1 + (d_c * cycle_length)) ^ (0:n_cycles))


# Assume v_cost_cp and v_cost_pp include all transition-specific costs correctly
# Compute total QALYs for each practice
total_qaly_cp <- sum(v_qalys_cp)
total_qaly_pp <- sum(v_qalys_pp)
total_cost_cp <- sum(v_cost_cp)
total_cost_pp <- sum(v_cost_pp)

# Apply within-cycle correction and discounting
n_tot_qaly_cp <- sum(v_qalys_cp * v_dwe * v_wcc)
n_tot_cost_cp <- sum(v_cost_cp * v_dwc * v_wcc)
n_tot_qaly_pp <- sum(v_qalys_pp * v_dwe * v_wcc)
n_tot_cost_pp <- sum(v_cost_pp * v_dwc * v_wcc)

# vector of costs
v_costs_str <- c(n_tot_cost_cp, n_tot_cost_pp)
v_qalys_str <- c(n_tot_qaly_cp, n_tot_qaly_pp)

# calculate incremental cost-effectiveness ratios (ICER)
v_names_str <- c("Current practice", "Proposed practice")

df_cea <- calculate_icers(cost = v_costs_str,
                                    effect = v_qalys_str,
                                    strategies = v_names_str)

# Traditional half cyle correction ------
v_dwe_hcc <- 1 / ((1 + (d_e * cycle_length/2)) ^ (0:n_cycles))

v_dwc_hcc <- 1 / ((1 + (d_c * cycle_length/2)) ^ (0:n_cycles))

n_tot_qaly_cp_hcc <- sum(v_qalys_cp *  v_dwc_hcc)
n_tot_cost_cp_hcc <- sum(v_cost_cp *  v_dwc_hcc)
n_tot_qaly_pp_hcc <- sum(v_qalys_pp *  v_dwe_hcc)
n_tot_cost_pp_hcc <- sum(v_cost_pp *  v_dwe_hcc)

# vector of costs
v_costs_str_hcc <- c(n_tot_cost_cp_hcc, n_tot_cost_pp_hcc)
v_qalys_str_hcc <- c(n_tot_qaly_cp_hcc, n_tot_qaly_pp_hcc)

df_cea_hcc <- calculate_icers(cost = v_costs_str_hcc,
                                    effect = v_qalys_str_hcc,
                                    strategies = v_names_str)
```


# Create traces and compare each health state between the outputs of TreeAge with R output
```{r echo=FALSE}
tree_age_cp <-
  read_excel(
    path = file.path(
      "C:/Users/kshah/OneDrive - The University of Sydney (Staff)/Markov vs microsim/Model/Markov model/Tree age model/Traces/Treeage - current practice - 31.05.2024.xlsx"
    )
  )

tree_age_pp <-
  read_excel(
    path = file.path(
      "C:/Users/kshah/OneDrive - The University of Sydney (Staff)/Markov vs microsim/Model/Markov model/Tree age model/Traces/Treeage - proposed practice - 31.05.2024.xlsx"
    )
  )

#
melt_cp_tree <- melt(tree_age_cp, id.vars = "Stage")
melt_pp_tree <- melt(tree_age_pp, id.vars = "Stage")

#
melt_cp_R <- melt(current_practice, id.vars = "Stage")
melt_pp_R <- melt(proposed_practice, id.vars = "Stage")


write.csv(melt_cp_R, file=file.path("C:/Users/kshah/OneDrive - The University of Sydney (Staff)/Markov vs microsim/Model/Markov model/R/Traces/R - current practice.csv"))

write.csv(melt_pp_R, file=file.path("C:/Users/kshah/OneDrive - The University of Sydney (Staff)/Markov vs microsim/Model/Markov model/R/Traces/R - proposed practice.csv"))
```

## Trace for on waitlist
```{r echo=FALSE}
# On waitlist
On_waitlist_pp_R <- melt_pp_R %>% 
  filter(variable == "Waitlist")

On_waitlist_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - On waitlist (dialysis)")

On_waitlist_pp_R$value <- as.numeric(On_waitlist_pp_R$value)

On_waitlist_pp_tree$value <- as.numeric(On_waitlist_pp_tree$value)

on_wait_pp<- ggplot() +
  geom_line(data = On_waitlist_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = On_waitlist_pp_tree,
            aes(x = Stage, y = value, colour = "Proposed Practice (TreeAge)")) +
  labs(title = "On waitlist PP") +
  scale_y_continuous("% of patients") +
  theme(legend.position = "none") +
  scale_colour_manual(name = "Legend",
                      values = c("Proposed Practice (R)" = "Green",
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
 On_waitlist_cp_R <- melt_cp_R %>% 
  filter(variable == "Waitlist")

On_waitlist_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - On waitlist (dialysis)")

On_waitlist_cp_R$value <- as.numeric(On_waitlist_cp_R$value)

On_waitlist_cp_tree$value <- as.numeric(On_waitlist_cp_tree$value)

on_wait_cp <- ggplot() +
  geom_line(data = On_waitlist_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = On_waitlist_cp_tree,
            aes(x = Stage, y = value, colour = "Current Practice (TreeAge)")) +
  labs(title = "On waitlist CP") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 
  

plot_grid(on_wait_cp, on_wait_pp)

```
## Trace for temporary off-waitlist
```{r echo=FALSE}
off_waitlist_pp_R <- melt_pp_R %>% 
  filter(variable == "Off_waitlist")

off_waitlist_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Temporary off-waitlist (dialysis)")

off_waitlist_pp_R$value <- as.numeric(off_waitlist_pp_R$value)

off_waitlist_pp_tree$value <- as.numeric(off_waitlist_pp_tree$value)

temp_pp <- ggplot() +
  geom_line(data = off_waitlist_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = off_waitlist_pp_tree,
            aes(x = Stage, y = value, colour = "Proposed Practice (TreeAge)")) +
  labs(title = "Off Waitlist PP") +
  scale_y_continuous("% of patients") +
    theme(legend.position = "none")  +
  scale_colour_manual(name = "Legend",
                      values = c("Proposed Practice (R)" = "Green",
                                 "Proposed Practice (TreeAge)" = "Red"))

#
off_waitlist_cp_R <- melt_cp_R %>% 
  filter(variable == "Off_waitlist")

off_waitlist_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Temporary off-waitlist (dialysis)")

off_waitlist_cp_R$value <- as.numeric(off_waitlist_cp_R$value)

off_waitlist_cp_tree$value <- as.numeric(off_waitlist_cp_tree$value)

temp_cp <- ggplot() +
  geom_line(data = off_waitlist_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = off_waitlist_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "Off Waitlist CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(temp_cp, temp_pp)

```

## Trace for DBD SCD

```{r echo=FALSE}
#good
DBDSCD_pp_R <- melt_pp_R %>% 
  filter(variable == "DBD_SCD_good")

DBDSCD_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Good graft function - DBD SCD")

DBDSCD_pp_R$value <- as.numeric(DBDSCD_pp_R$value)

DBDSCD_pp_tree$value <- as.numeric(DBDSCD_pp_tree$value)

DBDSCD_pp <- ggplot() +
  geom_line(data = DBDSCD_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = DBDSCD_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "DBD SCD PP (good)")  +
  scale_y_continuous("% of patients") +
  theme(legend.position = "none") +
  scale_colour_manual(name = "Legend",
                      values = c("Proposed Practice (R)" = "Green",
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
DBDSCD_cp_R <- melt_cp_R %>% 
  filter(variable == "DBD_SCD_good")

DBDSCD_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Good graft function - DBD SCD")

DBDSCD_cp_R$value <- as.numeric(DBDSCD_cp_R$value)

DBDSCD_cp_tree$value <- as.numeric(DBDSCD_cp_tree$value)

DBDSCD_cp <- ggplot() +
  geom_line(data = DBDSCD_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = DBDSCD_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "DBD SCD CP (good)") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 
# plot_grid(DBDSCD_pp, DBDSCD_cp)

# moderate
DBDSCD_pp_R_moderate <- melt_pp_R %>% 
  filter(variable == "DBD_SCD_moderate")

DBDSCD_pp_tree_moderate <- melt_pp_tree %>% 
  filter(variable == "% - Moderate graft function - DBD SCD")

DBDSCD_pp_R_moderate$value <- as.numeric(DBDSCD_pp_R_moderate$value)

DBDSCD_pp_tree_moderate$value <- as.numeric(DBDSCD_pp_tree_moderate$value)

DBDSCD_pp_moderate <- ggplot() +
  geom_line(data = DBDSCD_pp_R_moderate, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = DBDSCD_pp_tree_moderate,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "DBD SCD PP (moderate)")  + 
  scale_y_continuous("% of patients") +
    theme(legend.position = "none") +
  scale_colour_manual(name = "Legend",
                      values = c("Proposed Practice (R)" = "Green",
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
DBDSCD_cp_R_moderate <- melt_cp_R %>% 
  filter(variable == "DBD_SCD_moderate")

DBDSCD_cp_tree_moderate <- melt_cp_tree %>% 
  filter(variable == "% - Moderate graft function - DBD SCD")

DBDSCD_cp_R_moderate$value <- as.numeric(DBDSCD_cp_R_moderate$value)

DBDSCD_cp_tree_moderate$value <- as.numeric(DBDSCD_cp_tree_moderate$value)

DBDSCD_cp_moderate <- ggplot() +
  geom_line(data = DBDSCD_cp_R_moderate, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = DBDSCD_cp_tree_moderate,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "DBD SCD CP (moderate)") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(DBDSCD_pp_moderate, DBDSCD_cp_moderate)


# poor
DBDSCD_pp_R_poor <- melt_pp_R %>% 
  filter(variable == "DBD_SCD_poor")

DBDSCD_pp_tree_poor <- melt_pp_tree %>% 
  filter(variable == "% - Poor graft function - DBD SCD")

DBDSCD_pp_R_poor$value <- as.numeric(DBDSCD_pp_R_poor$value)

DBDSCD_pp_tree_poor$value <- as.numeric(DBDSCD_pp_tree_poor$value)

DBDSCD_pp_poor <- ggplot() +
  geom_line(data = DBDSCD_pp_R_poor, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = DBDSCD_pp_tree_poor,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "DBD SCD PP (poor)") +
  scale_y_continuous("% of patients") +
    theme(legend.position = "none") +
  scale_colour_manual(name = "Legend",
                      values = c("Proposed Practice (R)" = "Green",
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
DBDSCD_cp_R_poor <- melt_cp_R %>% 
  filter(variable == "DBD_SCD_poor")

DBDSCD_cp_tree_poor <- melt_cp_tree %>% 
  filter(variable == "% - Poor graft function - DBD SCD")

DBDSCD_cp_R_poor$value <- as.numeric(DBDSCD_cp_R_poor$value)

DBDSCD_cp_tree_poor$value <- as.numeric(DBDSCD_cp_tree_poor$value)

DBDSCD_cp_poor <- ggplot() +
  geom_line(data = DBDSCD_cp_R_poor, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = DBDSCD_cp_tree_poor,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "DBD SCD CP (poor)") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(DBDSCD_pp_poor, DBDSCD_cp_poor)
```

## Trace for DBD ECD
```{r}
# Good
DBDECD_pp_R_good <- melt_pp_R %>% 
  filter(variable == "DBD_ECD_good")

DBDECD_pp_tree_good <- melt_pp_tree %>% 
  filter(variable == "% - Good graft function - DBD ECD")

DBDECD_pp_R_good$value <- as.numeric(DBDECD_pp_R_good$value)

DBDECD_pp_tree_good$value <- as.numeric(DBDECD_pp_tree_good$value)

DBDECD_pp_good <- ggplot() +
  geom_line(data = DBDECD_pp_R_good, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = DBDECD_pp_tree_good,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "DBD ECD pp (good)") +
  scale_y_continuous("% of patients") +
  theme(legend.position = "none") +
  scale_colour_manual(name = "Legend",
                      values = c("Proposed Practice (R)" = "Green",
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
DBDECD_cp_R_good <- melt_cp_R %>% 
  filter(variable == "DBD_ECD_good")

DBDECD_cp_tree_good <- melt_cp_tree %>% 
  filter(variable == "% - Good graft function - DBD ECD")

DBDECD_cp_R_good$value <- as.numeric(DBDECD_cp_R_good$value)

DBDECD_cp_tree_good$value <- as.numeric(DBDECD_cp_tree_good$value)

DBDECD_cp_good <- ggplot() +
  geom_line(data = DBDECD_cp_R_good, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = DBDECD_cp_tree_good,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "DBD ECD CP (good)") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(DBDECD_pp_good, DBDECD_cp_good)


# Moderate
DBDECD_pp_R_moderate <- melt_pp_R %>% 
  filter(variable == "DBD_ECD_moderate")

DBDECD_pp_tree_moderate <- melt_pp_tree %>% 
  filter(variable == "% - Moderate graft function - DBD ECD")

DBDECD_pp_R_moderate$value <- as.numeric(DBDECD_pp_R_moderate$value)

DBDECD_pp_tree_moderate$value <- as.numeric(DBDECD_pp_tree_moderate$value)

DBDECD_pp_moderate <- ggplot() +
  geom_line(data = DBDECD_pp_R_moderate, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = DBDECD_pp_tree_moderate,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "DBD ECD PP (moderate)") +
  scale_y_continuous("% of patients") +
  theme(legend.position = "none") +
  scale_colour_manual(name = "Legend",
                      values = c("Proposed Practice (R)" = "Green",
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
DBDECD_cp_R_moderate <- melt_cp_R %>% 
  filter(variable == "DBD_ECD_moderate")

DBDECD_cp_tree_moderate <- melt_cp_tree %>% 
  filter(variable == "% - Moderate graft function - DBD ECD")

DBDECD_cp_R_moderate$value <- as.numeric(DBDECD_cp_R_moderate$value)

DBDECD_cp_tree_moderate$value <- as.numeric(DBDECD_cp_tree_moderate$value)

DBDECD_cp_moderate <- ggplot() +
  geom_line(data = DBDECD_cp_R_moderate, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = DBDECD_cp_tree_moderate,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "DBD ECD CP (moderate)") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(DBDECD_pp_moderate, DBDECD_cp_moderate)


# Poor
DBDECD_pp_R_poor <- melt_pp_R %>% 
  filter(variable == "DBD_ECD_poor")

DBDECD_pp_tree_poor <- melt_pp_tree %>% 
  filter(variable == "% - Poor graft function - DBD ECD")

DBDECD_pp_R_poor$value <- as.numeric(DBDECD_pp_R_poor$value)

DBDECD_pp_tree_poor$value <- as.numeric(DBDECD_pp_tree_poor$value)

DBDECD_pp_poor <- ggplot() +
  geom_line(data = DBDECD_pp_R_poor, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = DBDECD_pp_tree_poor,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "DBD ECD PP (poor)") +
  scale_y_continuous("% of patients") +
  theme(legend.position = "none") +
  scale_colour_manual(name = "Legend",
                      values = c("Proposed Practice (R)" = "Green",
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
DBDECD_cp_R_poor <- melt_cp_R %>% 
  filter(variable == "DBD_ECD_poor")

DBDECD_cp_tree_poor <- melt_cp_tree %>% 
  filter(variable == "% - Poor graft function - DBD ECD")

DBDECD_cp_R_poor$value <- as.numeric(DBDECD_cp_R_poor$value)

DBDECD_cp_tree_poor$value <- as.numeric(DBDECD_cp_tree_poor$value)

DBDECD_cp_poor <- ggplot() +
  geom_line(data = DBDECD_cp_R_poor, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = DBDECD_cp_tree_poor,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "DBD ECD CP (poor)") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(DBDECD_pp_poor, DBDECD_cp_poor)
```

## Trace for DCD
```{r}
DCD_pp_R_good <- melt_pp_R %>% 
  filter(variable == "DCD_good")

DCD_pp_tree_good <- melt_pp_tree %>% 
  filter(variable == "% - Good graft function - DCD")

DCD_pp_R_good$value <- as.numeric(DCD_pp_R_good$value)

DCD_pp_tree_good$value <- as.numeric(DCD_pp_tree_good$value)

DCD_pp_good <- ggplot() +
  geom_line(data = DCD_pp_R_good, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = DCD_pp_tree_good,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "DCD PP (good)") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
DCD_cp_R_good <- melt_cp_R %>% 
  filter(variable == "DCD_good")

DCD_cp_tree_good <- melt_cp_tree %>% 
  filter(variable == "% - Good graft function - DCD")

DCD_cp_R_good$value <- as.numeric(DCD_cp_R_good$value)

DCD_cp_tree_good$value <- as.numeric(DCD_cp_tree_good$value)

DCD_cp_good <- ggplot() +
  geom_line(data = DCD_cp_R_good, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = DCD_cp_tree_good,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "DCD CP (good)") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(DCD_pp_good, DCD_cp_good)


#moderate
DCD_pp_R_moderate <- melt_pp_R %>% 
  filter(variable == "DCD_moderate")

DCD_pp_tree_moderate <- melt_pp_tree %>% 
  filter(variable == "% - Moderate graft function - DCD")

DCD_pp_R_moderate$value <- as.numeric(DCD_pp_R_moderate$value)

DCD_pp_tree_moderate$value <- as.numeric(DCD_pp_tree_moderate$value)

DCD_pp_moderate <- ggplot() +
  geom_line(data = DCD_pp_R_moderate, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = DCD_pp_tree_moderate,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "DCD PP (moderate)") +
    theme(legend.position = "none") +

  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
DCD_cp_R_moderate <- melt_cp_R %>% 
  filter(variable == "DCD_moderate")

DCD_cp_tree_moderate <- melt_cp_tree %>% 
  filter(variable == "% - Moderate graft function - DCD")

DCD_cp_R_moderate$value <- as.numeric(DCD_cp_R_moderate$value)

DCD_cp_tree_moderate$value <- as.numeric(DCD_cp_tree_moderate$value)

DCD_cp_moderate <- ggplot() +
  geom_line(data = DCD_cp_R_moderate, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = DCD_cp_tree_moderate,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "DCD CP (moderate)") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(DCD_pp_moderate, DCD_cp_moderate)


#poor
DCD_pp_R_poor <- melt_pp_R %>% 
  filter(variable == "DCD_poor")

DCD_pp_tree_poor <- melt_pp_tree %>% 
  filter(variable == "% - Poor graft function - DCD")

DCD_pp_R_poor$value <- as.numeric(DCD_pp_R_poor$value)

DCD_pp_tree_poor$value <- as.numeric(DCD_pp_tree_poor$value)

DCD_pp_poor <- ggplot() +
  geom_line(data = DCD_pp_R_poor, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = DCD_pp_tree_poor,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "DCD PP (poor)") +
    theme(legend.position = "none") +

  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
DCD_cp_R_poor <- melt_cp_R %>% 
  filter(variable == "DCD_poor")

DCD_cp_tree_poor <- melt_cp_tree %>% 
  filter(variable == "% - Poor graft function - DCD")

DCD_cp_R_poor$value <- as.numeric(DCD_cp_R_poor$value)

DCD_cp_tree_poor$value <- as.numeric(DCD_cp_tree_poor$value)

DCD_cp_poor <- ggplot() +
  geom_line(data = DCD_cp_R_poor, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = DCD_cp_tree_poor,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "DCD CP (poor)") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(DCD_pp_poor, DCD_cp_poor)
```

## Trace for good graft function
```{r echo=FALSE}
ggf_pp_R <- melt_pp_R %>% 
  filter(variable == "Good_graft")

ggf_pp_tree <- melt_pp_tree %>% 
  filter(variable == "Good_graft")

ggf_pp_R$value <- as.numeric(ggf_pp_R$value)

ggf_pp_tree$value <- as.numeric(ggf_pp_tree$value)

good_graft_pp <- ggplot() +
  geom_line(data = ggf_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = ggf_pp_tree,
            aes(x = Stage, y = value, colour = "Proposed Practice (TreeAge)")) +
  labs(title = "Good graft PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
ggf_cp_R <- melt_cp_R %>% 
  filter(variable == "Good_graft")

ggf_cp_tree <- melt_cp_tree %>% 
  filter(variable == "Good_graft")

ggf_cp_R$value <- as.numeric(ggf_cp_R$value)

ggf_cp_tree$value <- as.numeric(ggf_cp_tree$value)

good_graft_cp <- ggplot() +
  geom_line(data = ggf_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = ggf_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "Good graft CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(good_graft_pp, good_graft_cp)

```


## Trace for moderate graft function
```{r echo=FALSE}
mgf_pp_R <- melt_pp_R %>% 
  filter(variable == "Moderate_graft")

mgf_pp_tree <- melt_pp_tree %>% 
  filter(variable == "Moderate_graft")

mgf_pp_R$value <- as.numeric(mgf_pp_R$value)
mgf_pp_tree$value <- as.numeric(mgf_pp_tree$value)

moderate_pp <- ggplot() +
  geom_line(data = mgf_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = mgf_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "Moderate graft PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
mgf_cp_R <- melt_cp_R %>% 
  filter(variable == "Moderate_graft")

mgf_cp_tree <- melt_cp_tree %>% 
  filter(variable == "Moderate_graft")

mgf_cp_R$value <- as.numeric(mgf_cp_R$value)
mgf_cp_tree$value <- as.numeric(mgf_cp_tree$value)

moderate_cp <- ggplot() +
  geom_line(data = mgf_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = mgf_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "Moderate graft CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(moderate_pp, moderate_cp)

```

## Trace for poor graft function
```{r echo=FALSE}
pgf_pp_R <- melt_pp_R %>% 
  filter(variable == "Poor_graft")

pgf_pp_tree <- melt_pp_tree %>% 
  filter(variable == "Poor_graft")

pgf_pp_R$value <- as.numeric(pgf_pp_R$value)
pgf_pp_tree$value <- as.numeric(pgf_pp_tree$value)

poor_pp <- ggplot() +
  geom_line(data = pgf_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = pgf_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "Poor graft PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
pgf_cp_R <- melt_cp_R %>% 
  filter(variable == "Poor_graft")

pgf_cp_tree <- melt_cp_tree %>% 
  filter(variable == "Poor_graft")

pgf_cp_R$value <- as.numeric(pgf_cp_R$value)
pgf_cp_tree$value <- as.numeric(pgf_cp_tree$value)

poor_cp <- ggplot() +
  geom_line(data = pgf_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = pgf_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "Poor graft CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(poor_pp, poor_cp)

```

## Trace for HIV
```{r echo=FALSE}
HIV_pp_R<- melt_pp_R %>% 
  filter(variable == "HIV")

HIV_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Post transplant HIV")

HIV_pp_R$value <- as.numeric(HIV_pp_R$value)

HIV_pp_tree$value <- as.numeric(HIV_pp_tree$value)

HIV_pp <- ggplot() +
  geom_line(data = HIV_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = HIV_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "HIV PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))


# 
HIV_cp_R<- melt_cp_R %>% 
  filter(variable == "HIV")

HIV_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Post transplant HIV")

HIV_cp_R$value <- as.numeric(HIV_cp_R$value)

HIV_cp_tree$value <- as.numeric(HIV_cp_tree$value)

HIV_cp <- ggplot() +
  geom_line(data = HIV_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = HIV_cp_tree,
            aes(x = Stage, y = value, color =  "Current Practice (TreeAge)")) +
  labs(title = "HIV CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(HIV_pp, HIV_cp)

```

## Trace for HBV
```{r echo=FALSE}
HBV_pp_R<- melt_pp_R %>% 
  filter(variable == "HBV")

HBV_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Post transplant HBV - Chronic HBV")

HBV_pp_R$value <- as.numeric(HBV_pp_R$value)

HBV_pp_tree$value <- as.numeric(HBV_pp_tree$value)

HBV_pp <- ggplot() +
  geom_line(data = HBV_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = HBV_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "HBV PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))


# 
HBV_cp_R<- melt_cp_R %>% 
  filter(variable == "HBV")

HBV_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Post transplant HBV - Chronic HBV")

HBV_cp_R$value <- as.numeric(HBV_cp_R$value)

HBV_cp_tree$value <- as.numeric(HBV_cp_tree$value)

HBV_cp <- ggplot() +
  geom_line(data = HBV_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = HBV_cp_tree,
            aes(x = Stage, y = value, color =  "Current Practice (TreeAge)")) +
  labs(title = "HBV CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(HBV_pp, HBV_cp)

```

## Trace for HCV
```{r echo=FALSE}
HCV_pp_R<- melt_pp_R %>% 
  filter(variable == "HCV")

HCV_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Post transplant HCV")

HCV_pp_R$value <- as.numeric(HCV_pp_R$value)

HCV_pp_tree$value <- as.numeric(HCV_pp_tree$value)

HCV_pp <- ggplot() +
  geom_line(data = HCV_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = HCV_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "HCV proposed") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
HCV_cp_R<- melt_cp_R %>% 
  filter(variable == "HCV")

HCV_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Post transplant HCV")

HCV_cp_R$value <- as.numeric(HCV_cp_R$value)

HCV_cp_tree$value <- as.numeric(HCV_cp_tree$value)

HCV_cp <- ggplot() +
  geom_line(data = HCV_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = HCV_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "HCV current") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(HCV_pp, HCV_cp)

```


## HBV Compensated cirrhosis
```{r}
#
HBV_compcir_pp_R <- melt_pp_R %>% 
  filter(variable == "HepB_Comp_cirr")

HBV_compcir_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Hep B - Compensated Cirrhosis")

HBV_compcir_pp_R$value <- as.numeric(HBV_compcir_pp_R$value)

HBV_compcir_pp_tree$value <- as.numeric(HBV_compcir_pp_tree$value)

HBV_compcir_pp <- ggplot() +
  geom_line(data = HBV_compcir_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = HBV_compcir_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "HBV comp cirr PP") +
  scale_y_continuous("% of patients")+
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
HBV_compcir_cp_R <- melt_cp_R %>% 
  filter(variable == "HepB_Comp_cirr")

HBV_compcir_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Hep B - Compensated Cirrhosis")

HBV_compcir_cp_R$value <- as.numeric(HBV_compcir_cp_R$value)

HBV_compcir_cp_tree$value <- as.numeric(HBV_compcir_cp_tree$value)

HBV_compcir_cp <- ggplot() +
  geom_line(data = HBV_compcir_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = HBV_compcir_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "HBV comp cirr CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(HBV_compcir_pp, HBV_compcir_cp)

```

## HCV Compensated cirrhosis
```{r}
#
HCV_compcir_pp_R <- melt_pp_R %>% 
  filter(variable == "HepC_Comp_cirr")

HCV_compcir_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Hep C - Compensated cirrhosis")

HCV_compcir_pp_R$value <- as.numeric(HCV_compcir_pp_R$value)

HCV_compcir_pp_tree$value <- as.numeric(HCV_compcir_pp_tree$value)

HCV_compcir_pp <- ggplot() +
  geom_line(data = HCV_compcir_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = HCV_compcir_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "HCV comp cirr PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
HCV_compcir_cp_R <- melt_cp_R %>% 
  filter(variable == "HepC_Comp_cirr")

HCV_compcir_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Hep C - Compensated cirrhosis")

HCV_compcir_cp_R$value <- as.numeric(HCV_compcir_cp_R$value)

HCV_compcir_cp_tree$value <- as.numeric(HCV_compcir_cp_tree$value)

HCV_compcir_cp <- ggplot() +
  geom_line(data = HCV_compcir_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = HCV_compcir_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "HCV comp cirr CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(HCV_compcir_pp, HCV_compcir_cp)

```


## HBV Decompensated cirrhosis
```{r}
#
HBV_decompcir_pp_R <- melt_pp_R %>% 
  filter(variable == "HepB_Decomp_cirr")

HBV_decompcir_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Hep B - Decompensated Cirrhosis")

HBV_decompcir_pp_R$value <- as.numeric(HBV_decompcir_pp_R$value)

HBV_decompcir_pp_tree$value <- as.numeric(HBV_decompcir_pp_tree$value)

HBV_decompcir_pp <- ggplot() +
  geom_line(data = HBV_decompcir_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = HBV_decompcir_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "HBV decomp cirr PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
HBV_decompcir_cp_R <- melt_cp_R %>% 
  filter(variable == "HepB_Decomp_cirr")

HBV_decompcir_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Hep B - Decompensated Cirrhosis")

HBV_decompcir_cp_R$value <- as.numeric(HBV_decompcir_cp_R$value)

HBV_decompcir_cp_tree$value <- as.numeric(HBV_decompcir_cp_tree$value)

HBV_decompcir_cp <- ggplot() +
  geom_line(data = HBV_decompcir_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = HBV_decompcir_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "HBV decomp cirr CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(HBV_decompcir_pp, HBV_decompcir_cp)

```

## HCV Decompensated cirrhosis
```{r}
#
HCV_decompcir_pp_R <- melt_pp_R %>% 
  filter(variable == "HepC_Decomp_cirr")

HCV_decompcir_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Hep C - Decompensated cirrhosis")

HCV_decompcir_pp_R$value <- as.numeric(HCV_decompcir_pp_R$value)

HCV_decompcir_pp_tree$value <- as.numeric(HCV_decompcir_pp_tree$value)

HCV_decompcir_pp <- ggplot() +
  geom_line(data = HCV_decompcir_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = HCV_decompcir_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "HCV decomp cirr PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
HCV_decompcir_cp_R <- melt_cp_R %>% 
  filter(variable == "HepC_Decomp_cirr")

HCV_decompcir_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Hep C - Decompensated cirrhosis")

HCV_decompcir_cp_R$value <- as.numeric(HCV_decompcir_cp_R$value)

HCV_decompcir_cp_tree$value <- as.numeric(HCV_decompcir_cp_tree$value)

HCV_decompcir_cp <- ggplot() +
  geom_line(data = HCV_decompcir_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = HCV_decompcir_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "HCV decomp cirr CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(HCV_decompcir_pp, HCV_decompcir_cp)

```


## HBV Hepatocellular carcinoma
```{r}
#
HBV_hcc_pp_R <- melt_pp_R %>% 
  filter(variable == "HepB_HCC")

HBV_hcc_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Hep B - Hepatocellular carcinoma")

HBV_hcc_pp_R$value <- as.numeric(HBV_hcc_pp_R$value)

HBV_hcc_pp_tree$value <- as.numeric(HBV_hcc_pp_tree$value)

HBV_hcc_pp <- ggplot() +
  geom_line(data = HBV_hcc_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = HBV_hcc_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "HBV HCC PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
HBV_hcc_cp_R <- melt_cp_R %>% 
  filter(variable == "HepB_HCC")

HBV_hcc_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Hep B - Hepatocellular carcinoma")

HBV_hcc_cp_R$value <- as.numeric(HBV_hcc_cp_R$value)

HBV_hcc_cp_tree$value <- as.numeric(HBV_hcc_cp_tree$value)

HBV_hcc_cp <- ggplot() +
  geom_line(data = HBV_hcc_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = HBV_hcc_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "HBV HCC CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(HBV_hcc_pp, HBV_hcc_cp)

```


## HCV Hepatocellular carcinoma
```{r}
#
hcv_hcc_pp_R <- melt_pp_R %>% 
  filter(variable == "HepC_HCC")

hcv_hcc_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Hep C - Hepatocellular carcinoma")

hcv_hcc_pp_R$value <- as.numeric(hcv_hcc_pp_R$value)

hcv_hcc_pp_tree$value <- as.numeric(hcv_hcc_pp_tree$value)

hcv_hcc_pp <- ggplot() +
  geom_line(data = hcv_hcc_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = hcv_hcc_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "HCV HCC PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
hcv_hcc_cp_R <- melt_cp_R %>% 
  filter(variable == "HepC_HCC")

hcv_hcc_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Hep C - Hepatocellular carcinoma")

hcv_hcc_cp_R$value <- as.numeric(hcv_hcc_cp_R$value)

hcv_hcc_cp_tree$value <- as.numeric(hcv_hcc_cp_tree$value)

hcv_hcc_cp <- ggplot() +
  geom_line(data = hcv_hcc_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = hcv_hcc_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "HCV HCC CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(hcv_hcc_pp, hcv_hcc_cp)

```

## Liver transplant year 1

```{r}
#
hcv_lt_pp_R <- melt_pp_R %>% 
  filter(variable == "Liver_trans_1yr")

hcv_lt_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Liver transplant year 1")

hcv_lt_pp_R$value <- as.numeric(hcv_lt_pp_R$value)

hcv_lt_pp_tree$value <- as.numeric(hcv_lt_pp_tree$value)

hcv_lt_pp_1 <- ggplot() +
  geom_line(data = hcv_lt_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = hcv_lt_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "LT year 1 PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
hcv_lt_cp_R <- melt_cp_R %>% 
  filter(variable == "Liver_trans_1yr")

hcv_lt_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Liver transplant year 1")

hcv_lt_cp_R$value <- as.numeric(hcv_lt_cp_R$value)

hcv_lt_cp_tree$value <- as.numeric(hcv_lt_cp_tree$value)

hcv_lt_cp_1 <- ggplot() +
  geom_line(data = hcv_lt_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = hcv_lt_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "LT year 1 CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 
plot_grid(hcv_lt_pp_1, hcv_lt_cp_1)

```

## Liver transplant year 2+

```{r}
#
hcv_lt_yr2_pp_R <- melt_pp_R %>% 
  filter(variable == "Liver_trans_2yr")

hcv_lt_yr_2_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Liver transplant year 2 +")

hcv_lt_yr2_pp_R$value <- as.numeric(hcv_lt_yr2_pp_R$value)

hcv_lt_yr_2_pp_tree$value <- as.numeric(hcv_lt_yr_2_pp_tree$value)

hcv_lt_pp <- ggplot() +
  geom_line(data = hcv_lt_yr2_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = hcv_lt_yr_2_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "LT year 2 PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
hcv_lt_yr2_cp_R <- melt_cp_R %>% 
  filter(variable == "Liver_trans_2yr")

hcv_lt_yr_2_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Liver transplant year 2 +")

hcv_lt_yr2_cp_R$value <- as.numeric(hcv_lt_yr2_cp_R$value)

hcv_lt_yr_2_cp_tree$value <- as.numeric(hcv_lt_yr_2_cp_tree$value)

hcv_lt_cp <- ggplot() +
  geom_line(data = hcv_lt_yr2_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = hcv_lt_yr_2_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "LT year 2 CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(hcv_lt_pp, hcv_lt_cp)

```


## Trace for death on waitlist
```{r echo=FALSE}
Death_pp_R <- melt_pp_R %>% 
  filter(variable == "Death_waitlist")

Death_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Death on waitlist")

Death_pp_R$value <- as.numeric(Death_pp_R$value)

Death_pp_tree$value <- as.numeric(Death_pp_tree$value)

Death_waitlist_pp <- ggplot() +
  geom_line(data = Death_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = Death_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "Death waitlist PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
Death_cp_R <- melt_cp_R %>% 
  filter(variable == "Death_waitlist")

Death_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Death on waitlist")

Death_cp_R$value <- as.numeric(Death_cp_R$value)

Death_cp_tree$value <- as.numeric(Death_cp_tree$value)

Death_waitlist_cp <- ggplot() +
  geom_line(data = Death_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = Death_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "Death waitlist CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(Death_waitlist_pp, Death_waitlist_cp)

```

## Trace for death w functioning graft
```{r echo=FALSE}
Death_pp_R <- melt_pp_R %>% 
  filter(variable == "Death_w_functioning_graft")

Death_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Death with functioning graft")

Death_pp_R$value <- as.numeric(Death_pp_R$value)

Death_pp_tree$value <- as.numeric(Death_pp_tree$value)

Death_other_pp <- ggplot() +
  geom_line(data = Death_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = Death_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "Death_w_functioning_graft PP") +
    theme(legend.position = "none") +
  scale_y_continuous("% of patients") +
  scale_colour_manual(name = "Legend", 
                      values = c("Proposed Practice (R)" = "Green", 
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
Death_cp_R <- melt_cp_R %>% 
  filter(variable == "Death_w_functioning_graft")

Death_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Death with functioning graft")

Death_cp_R$value <- as.numeric(Death_cp_R$value)

Death_cp_tree$value <- as.numeric(Death_cp_tree$value)

Death_other_cp <- ggplot() +
  geom_line(data = Death_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = Death_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "Death_w_functioning_graft CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(Death_other_pp, Death_other_cp)

```

## Trace for death off waitlist
```{r echo=FALSE}
Death_off_pp_R <- melt_pp_R %>% 
  filter(variable == "Death_off_waitlist")

Death_off_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Death on temporary off waitlist")

Death_off_pp_R$value <- as.numeric(Death_off_pp_R$value)

Death_off_pp_tree$value <- as.numeric(Death_off_pp_tree$value)

Death_off_waitlist_pp <- ggplot() +
  geom_line(data = Death_off_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = Death_off_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "Death off waitlist PP") +
  scale_y_continuous("% of patients") +
    theme(legend.position = "none") +
  scale_colour_manual(name = "Legend",
                      values = c("Proposed Practice (R)" = "Green",
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
Death_off_cp_R <- melt_cp_R %>% 
  filter(variable == "Death_off_waitlist")

Death_off_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Death on temporary off waitlist")

Death_off_cp_R$value <- as.numeric(Death_off_cp_R$value)

Death_off_cp_tree$value <- as.numeric(Death_off_cp_tree$value)

Death_off_waitlist_cp <- ggplot() +
  geom_line(data = Death_off_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = Death_off_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "Death off waitlist CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(Death_off_waitlist_pp, Death_off_waitlist_cp)

```


## Trace for death after graft failure
```{r echo=FALSE}
Death_graft_f_pp_R <- melt_pp_R %>% 
  filter(variable == "Death_after_graft_failure")

Death_graft_f_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Death after graft failure")

Death_graft_f_pp_R$value <- as.numeric(Death_graft_f_pp_R$value)

Death_graft_f_pp_tree$value <- as.numeric(Death_graft_f_pp_tree$value)

Death_graft_f_pp <- ggplot() +
  geom_line(data = Death_graft_f_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = Death_graft_f_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "Death graft failure PP") +
  scale_y_continuous("% of patients") +
    theme(legend.position = "none") +
  scale_colour_manual(name = "Legend",
                      values = c("Proposed Practice (R)" = "Green",
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
Death_graft_f_cp_R <- melt_cp_R %>% 
  filter(variable == "Death_after_graft_failure")

Death_graft_f_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Death after graft failure")

Death_graft_f_cp_R$value <- as.numeric(Death_graft_f_cp_R$value)

Death_graft_f_cp_tree$value <- as.numeric(Death_graft_f_cp_tree$value)

Death_graft_f_cp <- ggplot() +
  geom_line(data = Death_graft_f_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = Death_graft_f_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "Death graft failure CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 

plot_grid(Death_graft_f_pp, Death_graft_f_cp)

```

## Trace for death after liver failure
```{r echo=FALSE}
Death_esld_pp_R <- melt_pp_R %>% 
  filter(variable == "Death_liver")

Death_esld_pp_tree <- melt_pp_tree %>% 
  filter(variable == "% - Death due to end-stage liver disease")

Death_esld_pp_R$value <- as.numeric(Death_esld_pp_R$value)

Death_esld_pp_tree$value <- as.numeric(Death_esld_pp_tree$value)

Death_esld_pp <- ggplot() +
  geom_line(data = Death_esld_pp_R, 
            aes(x = Stage, y = value, colour = "Proposed Practice (R)")) +
  geom_line(data = Death_esld_pp_tree,
            aes(x = Stage, y = value, color = "Proposed Practice (TreeAge)")) +
  labs(title = "Death liver failure PP") +
  scale_y_continuous("% of patients")+
    theme(legend.position = "none") +
  scale_colour_manual(name = "Legend",
                      values = c("Proposed Practice (R)" = "Green",
                                 "Proposed Practice (TreeAge)" = "Red"))

# 
Death_esld_cp_R <- melt_cp_R %>% 
  filter(variable == "Death_liver")


Death_esld_cp_tree <- melt_cp_tree %>% 
  filter(variable == "% - Death due to end-stage liver disease")

Death_esld_cp_R$value <- as.numeric(Death_esld_cp_R$value)

Death_esld_cp_tree$value <- as.numeric(Death_esld_cp_tree$value)

Death_esld_cp <- ggplot() +
  geom_line(data = Death_esld_cp_R, 
            aes(x = Stage, y = value, colour = "Current Practice (R)")) +
  geom_line(data = Death_esld_cp_tree,
            aes(x = Stage, y = value, color = "Current Practice (TreeAge)")) +
  labs(title = "Death liver failure CP") +
  scale_colour_manual(name = "Legend",
                       labels = c("Current Practice (R)" = "R",
                                 "Current Practice (TreeAge)" = "TreeAge"),
                      values = c("Current Practice (R)" = "Green",
                                 "Current Practice (TreeAge)" = "Red")) 
    
plot_grid(Death_esld_pp, Death_esld_cp)

```

# Combine plots
```{r}
# 1
combined_plots_waitlist <- grid.arrange(on_wait_pp, on_wait_cp, temp_pp, temp_cp, Death_waitlist_pp, Death_waitlist_cp, Death_off_waitlist_pp, Death_off_waitlist_cp, ncol = 2, nrow = 4)

ggsave(file = file.path(figuresloc, "combined_plots_waitlist.pdf"), plot = combined_plots_waitlist, width = 16, height = 12)

# 2
combined_plots_dbdscd <- grid.arrange(DBDSCD_pp,DBDSCD_cp, DBDSCD_pp_moderate, DBDSCD_cp_moderate, DBDSCD_pp_poor, DBDSCD_cp_poor, ncol = 2, nrow = 3)

ggsave(file = file.path(figuresloc, "combined_plots_dbdscd.pdf"), plot = combined_plots_dbdscd, width = 16, height = 12)

# 3
combined_plots_dbdecd <- grid.arrange(DBDECD_pp_good, DBDECD_cp_good, DBDECD_pp_moderate, DBDECD_cp_moderate, DBDECD_pp_poor, DBDECD_cp_poor, ncol = 2, nrow = 3)

ggsave(file = file.path(figuresloc, "combined_plots_dbdecd.pdf"), plot = combined_plots_dbdecd, width = 16, height = 12)

# 4
combined_plots_dcd <- grid.arrange(DCD_pp_good, DCD_cp_good, DCD_pp_moderate, DCD_cp_moderate, DCD_pp_poor, DCD_cp_poor, ncol = 2, nrow = 3)

ggsave(file = file.path(figuresloc, "combined_plots_dcd.pdf"), plot = combined_plots_dcd, width = 16, height = 12)

# 5
combined_graft_pp <- grid.arrange(good_graft_pp, good_graft_cp, moderate_pp, moderate_cp, poor_pp, poor_cp, ncol = 2, nrow = 3)

ggsave(file = file.path(figuresloc, "combined_graft_pp.pdf"), plot = combined_graft_pp, width = 16, height = 12)

# 6 HBV
combined_hbv <- grid.arrange(HIV_pp, HIV_cp, HBV_pp, HBV_cp, HBV_compcir_pp, HBV_compcir_cp, HBV_decompcir_pp, HBV_decompcir_cp, HBV_hcc_pp, HBV_hcc_cp, ncol = 2, nrow = 5)

ggsave(file = file.path(figuresloc, "combined_hbv.pdf"), plot = combined_hbv, width = 16, height = 12)

# 6 HCV
combined_hcv <- grid.arrange(HCV_pp, HCV_cp, HCV_compcir_pp, HCV_compcir_cp, HCV_decompcir_pp, HCV_decompcir_cp, hcv_hcc_pp, hcv_hcc_cp, ncol = 2, nrow = 4)

ggsave(file = file.path(figuresloc, "combined_hcv.pdf"), plot = combined_hcv, width = 16, height = 12)

# 7 LT
combined_lt <- grid.arrange(hcv_lt_pp_1, hcv_lt_cp_1, hcv_lt_pp, hcv_lt_cp, Death_esld_pp, Death_esld_cp, ncol = 2, nrow = 3)

ggsave(file = file.path(figuresloc, "combined_lt.pdf"), plot = combined_lt, width = 16, height = 12)

# 8 death
combined_death <- grid.arrange(Death_other_pp, Death_other_cp, Death_graft_f_pp, Death_graft_f_cp, ncol = 2, nrow = 2)

ggsave(file = file.path(figuresloc, "combined_death.pdf"), plot = combined_death, width = 16, height = 12)
```








